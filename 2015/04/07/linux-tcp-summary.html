<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CPT+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.yvanz.com","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.17.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"style":null,"show_result":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="article">
<meta property="og:title" content="Linux TCP队列相关参数的总结">
<meta property="og:url" content="https://www.yvanz.com/2015/04/07/linux-tcp-summary.html">
<meta property="og:site_name" content="Yvanの平行时空">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://img4.tbcdn.cn/L1/461/1/33c6ebe8e3f20cbe799ff483bec551d0d0cdf798">
<meta property="og:image" content="http://img3.tbcdn.cn/L1/461/1/73d01c4c8164ae8642ff09d5d3fe0548d4162874">
<meta property="og:image" content="http://img4.tbcdn.cn/L1/461/1/a252ea502f0c109d6db0d6ccbba269e38fea7843">
<meta property="og:image" content="http://img1.tbcdn.cn/L1/461/1/08914f8ebbbb226e39f2e6e04f574e361e87b0ed">
<meta property="og:image" content="http://img4.tbcdn.cn/L1/461/1/1b58f78cd7e41704b2b1504cb1bb1bb3433c421c">
<meta property="og:image" content="http://img1.tbcdn.cn/L1/461/1/2e7a9a3a5da675786312e6eefbf0b5959b4be130">
<meta property="og:image" content="http://img1.tbcdn.cn/L1/461/1/ad04bdd5ec90d2fb24e763e6903cdd16d4a48d74">
<meta property="og:image" content="http://img4.tbcdn.cn/L1/461/1/29e441e2417f14038a2b80fe797124f01960e158">
<meta property="og:image" content="http://img4.tbcdn.cn/L1/461/1/1c6cb73c7ca060b6c1dac825f60dcd5e03d5238b">
<meta property="og:image" content="http://img4.tbcdn.cn/L1/461/1/21a3ebef1dadd6d18d982eb3a325dd6075ef14e4">
<meta property="og:image" content="http://img1.tbcdn.cn/L1/461/1/6dcf86b5eb148f95d5ea7d64f698734b9b9cd7f3">
<meta property="og:image" content="http://img1.tbcdn.cn/L1/461/1/2e7a9a3a5da675786312e6eefbf0b5959b4be130">
<meta property="og:image" content="http://img1.tbcdn.cn/L1/461/1/f95a88bc6e0327c1173f4736d881ab3e531f9e21">
<meta property="og:image" content="http://img2.tbcdn.cn/L1/461/1/fae4d502f54dea93565e0facd4fb9686e27d16de">
<meta property="og:image" content="http://img4.tbcdn.cn/L1/461/1/b682793c235a93fe9a588c7892895659bbdd4111">
<meta property="article:published_time" content="2015-04-07T04:01:00.000Z">
<meta property="article:modified_time" content="2023-06-19T01:56:31.697Z">
<meta property="article:author" content="Yvan">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="转载学习">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://img4.tbcdn.cn/L1/461/1/33c6ebe8e3f20cbe799ff483bec551d0d0cdf798">


<link rel="canonical" href="https://www.yvanz.com/2015/04/07/linux-tcp-summary.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.yvanz.com/2015/04/07/linux-tcp-summary.html","path":"2015/04/07/linux-tcp-summary.html","title":"Linux TCP队列相关参数的总结"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Linux TCP队列相关参数的总结 | Yvanの平行时空</title>
  

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?0e81de7acd8e4713d34af0da61a0f243"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Yvanの平行时空</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Yvan"
      src="https://statics.yvanz.com/avatar.jpg">
  <p class="site-author-name" itemprop="name">Yvan</p>
  <div class="site-description" itemprop="description">若当初的你，和现在的我，可以重来过</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">61</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/yvanz" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;yvanz" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/n/Yvan_OPS" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;n&#x2F;Yvan_OPS" rel="noopener me" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
          链接
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <a href="http://www.bnard.cn/" title="http:&#x2F;&#x2F;www.bnard.cn&#x2F;" rel="noopener" target="_blank">BnArD</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="http://hustcat.github.io/" title="http:&#x2F;&#x2F;hustcat.github.io&#x2F;" rel="noopener" target="_blank">YY哥</a>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.yvanz.com/2015/04/07/linux-tcp-summary.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://statics.yvanz.com/avatar.jpg">
      <meta itemprop="name" content="Yvan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yvanの平行时空">
      <meta itemprop="description" content="若当初的你，和现在的我，可以重来过">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Linux TCP队列相关参数的总结 | Yvanの平行时空">
      <meta itemprop="description" content=" ">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Linux TCP队列相关参数的总结
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-04-07 12:01:00" itemprop="dateCreated datePublished" datetime="2015-04-07T12:01:00+08:00">2015-04-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF%E5%AE%85/" itemprop="url" rel="index"><span itemprop="name">技术宅</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2015/04/07/linux-tcp-summary.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/04/07/linux-tcp-summary.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

            <div class="post-description"> </div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>锋寒 技术保障 基础平台 技术专家</p>
<p>在Linux上做网络应用的性能优化时，一般都会对TCP相关的内核参数进行调节，特别是和缓冲、队列有关的参数。网上搜到的文章会告诉你需要修改哪些参数，但我们经常是知其然而不知其所以然，每次照抄过来后，可能很快就忘记或混淆了它们的含义。本文尝试总结TCP队列缓冲相关的内核参数，从协议栈的角度梳理它们，希望可以更容易的理解和记忆。注意，本文内容均来源于参考文档，没有去读相关的内核源码做验证，不能保证内容严谨正确。作为Java程序员没读过内核源码是硬伤。</p>
<p>下面我以server端为视角，从&amp;nbsp;<wbr /><span style="word-wrap: normal; word-break: normal; line-height: 24px; box-sizing: border-box; font-weight: 700;">连接建立</span>、&amp;nbsp;<wbr /><span style="word-wrap: normal; word-break: normal; line-height: 24px; box-sizing: border-box; font-weight: 700;">数据包接收</span>&amp;nbsp;<wbr />和&amp;nbsp;<wbr /><span style="word-wrap: normal; word-break: normal; line-height: 24px; box-sizing: border-box; font-weight: 700;">数据包发送</span>&amp;nbsp;<wbr />这3条路径对参数进行归类梳理。</p>
<p>一、连接建立</p>
<p><img data-src="http://img4.tbcdn.cn/L1/461/1/33c6ebe8e3f20cbe799ff483bec551d0d0cdf798"></p>
<p>简单看下连接的建立过程，客户端向server发送<code>SYN</code>包，server回复<code>SYN＋ACK</code>，同时将这个处于<code>SYN_RECV</code>状态的连接保存到半连接队列。客户端返回<code>ACK</code>包完成三次握手，server将<code>ESTABLISHED</code>状态的连接移入accept队列，等待应用调用accept()。</p>
<p>可以看到建立连接涉及两个队列：</p>
<ul>
<li><span style="word-wrap: normal; word-break: normal; line-height: 24px; box-sizing: border-box; font-weight: 700;">半连接队列</span>，保存<code>SYN_RECV</code>状态的连接。队列长度由<code>net.ipv4.tcp_max_syn_backlog</code>设置</li>
<li><span style="word-wrap: normal; word-break: normal; box-sizing: border-box; font-weight: 700;">accept队列</span>，保存<code>ESTABLISHED</code>状态的连接。队列长度为<code>min(net.core.somaxconn, backlog)</code>。其中backlog是我们创建<code>ServerSocket(int port,int backlog)</code>时指定的参数，最终会传递给listen方法：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include </span></span><br><span class="line">int listen(int sockfd, int backlog);</span><br></pre></td></tr></table></figure>

<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">如果我们设置的</span><code>backlog</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">大于</span><code>net.core.somaxconn</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">，accept队列的长度将被设置为</span><code>net.core.somaxconn</code></p>
<p>另外，为了应对<code>SYN flooding</code>（即客户端只发送SYN包发起握手而不回应ACK完成连接建立，填满server端的半连接队列，让它无法处理正常的握手请求），Linux实现了一种称为<code>SYN cookie</code>的机制，通过<code>net.ipv4.tcp_syncookies</code>控制，设置为1表示开启。简单说<code>SYN cookie</code>就是将连接信息编码在<code>ISN</code>(initial sequence number)中返回给客户端，这时server不需要将半连接保存在队列中，而是利用客户端随后发来的ACK带回的<code>ISN</code>还原连接信息，以完成连接的建立，避免了半连接队列被攻击SYN包填满。对于一去不复返的客户端握手，不理它就是了。</p>
<p>二、数据包的接收</p>
<p>先看看接收数据包经过的路径：</p>
<p><img data-src="http://img3.tbcdn.cn/L1/461/1/73d01c4c8164ae8642ff09d5d3fe0548d4162874"></p>
<p>数据包的接收，从下往上经过了三层：网卡驱动、系统内核空间，最后到用户态空间的应用。Linux内核使用<code>sk_buff</code>(<a target="_blank" rel="noopener" href="http://vger.kernel.org/~davem/skb.html">socket kernel buffers</a>)数据结构描述一个数据包。当一个新的数据包到达，<code>NIC</code>（network interface controller）调用<code>DMA engine</code>，通过<code>Ring Buffer</code>将数据包放置到内核内存区。<code>Ring Buffer</code>的大小固定，它不包含实际的数据包，而是包含了指向<code>sk_buff</code>的描述符。当<code>Ring Buffer</code>满的时候，新来的数据包将给丢弃。一旦数据包被成功接收，<code>NIC</code>发起中断，由内核的中断处理程序将数据包传递给IP层。经过IP层的处理，数据包被放入队列等待TCP层处理。每个数据包经过TCP层一系列复杂的步骤，更新TCP状态机，最终到达<code>recv Buffer</code>，等待被应用接收处理。有一点需要注意，数据包到达<code>recv Buffer</code>，TCP就会回<code>ACK</code>确认，既TCP的<code>ACK</code>表示数据包已经被操作系统内核收到，但并不确保应用层一定收到数据（例如这个时候系统crash），因此一般建议应用协议层也要设计自己的确认机制。</p>
<p>上面就是一个相当简化的数据包接收流程，让我们逐层看看队列缓冲有关的参数。</p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; font-weight: bold; line-height: 24px;">1.网卡Bonding模式</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">当主机有1个以上的网卡时，Linux会将多个网卡绑定为一个虚拟的bonded网络接口，对TCP&#x2F;IP而言只存在一个bonded网卡。多网卡绑定一方面能够提高网络吞吐量，另一方面也可以增强网络高可用。Linux支持7种Bonding模式：</span></p>
<ul>
<li><code>Mode 0 (balance-rr)</code>&amp;nbsp;<wbr />Round-robin策略，这个模式具备负载均衡和容错能力</li>
<li><code>Mode 1 (active-backup)</code>&amp;nbsp;<wbr />主备策略，在绑定中只有一个网卡被激活，其他处于备份状态</li>
<li><code>Mode 2 (balance-xor)</code>&amp;nbsp;<wbr />XOR策略，通过源MAC地址与目的MAC地址做异或操作选择slave网卡</li>
<li><code>Mode 3 (broadcast)</code>&amp;nbsp;<wbr />广播，在所有的网卡上传送所有的报文</li>
<li><code>Mode 4 (802.3ad)</code>&amp;nbsp;<wbr />IEEE 802.3ad 动态链路聚合。创建共享相同的速率和双工模式的聚合组</li>
<li><code>Mode 5 (balance-tlb)</code>&amp;nbsp;<wbr />Adaptive transmit load balancing</li>
<li><code>Mode 6 (balance-alb)</code>&amp;nbsp;<wbr />Adaptive load balancing</li>
</ul>
<p>&amp;nbsp;</p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">​</span><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">详细的说明参考内核文档</span><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/networking/bonding.txt">Linux Ethernet Bonding Driver HOWTO</a><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">。我们可以通过</span><code>cat /proc/net/bonding/bond0</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">查看本机的Bonding模式：</span></p>
<p><img data-src="http://img4.tbcdn.cn/L1/461/1/a252ea502f0c109d6db0d6ccbba269e38fea7843"></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">一般很少需要开发去设置网卡Bonding模式，自己实验的话可以参考</span><a target="_blank" rel="noopener" href="http://linux.cloudibee.com/2009/10/linux-network-bonding-setup-guide/">这篇文档</a></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; font-weight: bold; line-height: 24px;">2.网卡多队列及中断绑定</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">随着网络的带宽的不断提升，单核CPU已经不能满足网卡的需求，这时通过多队列网卡驱动的支持，可以将每个队列通过中断绑定到不同的CPU核上，充分利用多核提升数据包的处理能力。</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">首先查看网卡是否支持多队列，使用</span><code>lspci -vvv</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">命令，找到</span><code>Ethernet controller</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">项：</span></p>
<p><img data-src="http://img1.tbcdn.cn/L1/461/1/08914f8ebbbb226e39f2e6e04f574e361e87b0ed"></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">如果有MSI-X， Enable+ 并且Count &gt; 1，则该网卡是多队列网卡。</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">然后查看是否打开了网卡多队列。使用命令</span><code>cat /proc/interrupts</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">，如果看到eth0-TxRx-0表明多队列支持已经打开：</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;"><img data-src="http://img4.tbcdn.cn/L1/461/1/1b58f78cd7e41704b2b1504cb1bb1bb3433c421c"></span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">最后确认每个队列是否绑定到不同的CPU。</span><code>cat /proc/interrupts</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px; ">查询到每个队列的中断号，对应的文件</span><code>/proc/irq/$&#123;IRQ_NUM&#125;/smp_affinity</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px; ">为中断号IRQ_NUM绑定的CPU核的情况。以十六进制表示，每一位代表一个CPU核：</span></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">（00000001）代表CPU0</span><br><span class="line">（00000010）代表CPU1</span><br><span class="line">（00000011）代表CPU0和CPU1</span><br></pre></td></tr></table></figure>

<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">如果绑定的不均衡，可以手工设置，例如：</span></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;1&quot;</span> &gt; /proc/irq/99/smp_affinity  </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;2&quot;</span> &gt; /proc/irq/100/smp_affinity  </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;4&quot;</span> &gt; /proc/irq/101/smp_affinity  </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;8&quot;</span> &gt; /proc/irq/102/smp_affinity  </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;10&quot;</span> &gt; /proc/irq/103/smp_affinity  </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;20&quot;</span> &gt; /proc/irq/104/smp_affinity  </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;40&quot;</span> &gt; /proc/irq/105/smp_affinity  </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;80&quot;</span> &gt; /proc/irq/106/smp_affinity </span><br></pre></td></tr></table></figure>

<p><span style="word-wrap: normal; word-break: normal; line-height: 24px; font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; box-sizing: border-box; font-weight: 700;">3.Ring Buffer</span></p>
<p><code>Ring Buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">位于NIC和IP层之间，是一个典型的FIFO（先进先出）</span><a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Circular_buffer">环形队列</a><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px; ">。</span><code>Ring Buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">没有包含数据本身，而是包含了指向</span><code>sk_buff</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">（</span><a target="_blank" rel="noopener" href="http://vger.kernel.org/~davem/skb.html">socket kernel buffers</a><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">）的描述符。</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">可以使用</span><code>ethtool -g eth0</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">查看当前</span><code>Ring Buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">的设置：</span></p>
<p><img data-src="http://img1.tbcdn.cn/L1/461/1/2e7a9a3a5da675786312e6eefbf0b5959b4be130"></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">上面的例子接收队列为4096，传输队列为256。可以通过</span><code>ifconfig</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">观察接收和传输队列的运行状况：</span></p>
<p><img data-src="http://img1.tbcdn.cn/L1/461/1/ad04bdd5ec90d2fb24e763e6903cdd16d4a48d74"></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27px;">&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 1.RX errors:&amp;nbsp;收包总的错误数</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27px;">&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 2.RX dropped:&amp;nbsp;表示数据包已经进入了</span><code>Ring Buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27px;">，但是由于内存不够等系统原因，导致在拷贝到内存的过程中被丢弃。</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27px;">&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 3.RX overruns:&amp;nbsp;overruns意味着数据包没到</span><code>Ring Buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27px;">就被网卡物理层给丢弃了，而CPU无法及时的处理中断</span><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27px;">是造成</span><code>Ring Buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27px;">满的原因之一，例如中断分配的不均匀。</span><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27px;">当dropped数量持续增加，建议增大</span><code>Ring Buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27px;">，使用</span><code>ethtool -G</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27px;">进行设置。</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; font-weight: bold; line-height: 24px;">4.Input Packet Queue(数据包接收队列)</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">当接收数据包的速率大于内核TCP处理包的速率，数据包将会缓冲在TCP层之前的队列中。接收队列的长度由参数</span><code>net.core.netdev_max_backlog</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">设置。</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; font-weight: bold; line-height: 24px;">5.recv Buffer</span></p>
<p><code>recv buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">是调节TCP性能的关键参数。</span><code>BDP</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">(Bandwidth-delay product，带宽延迟积) 是网络的带宽和与</span><code>RTT</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">(round trip time)的乘积，</span><code>BDP</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">的含义是任意时刻处于在途未确认的最大数据量。</span><code>RTT</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">使用</span><code>ping</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">命令可以很容易的得到。为了达到最大的吞吐量，</span><code>recv Buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">的设置应该大于</span><code>BDP</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">，即</span><code>recv Buffer &gt;= bandwidth * RTT</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px; ">。假设带宽是100Mbps，</span><code>RTT</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">是100ms，那么</span><code>BDP</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">的计算如下：</span></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BDP = 100Mbps * 100ms = (100 / 8) * (100 / 1000) = 1.25MB</span><br></pre></td></tr></table></figure>

<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">Linux在2.6.17以后增加了</span><code>recv Buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px; background-color:">自动调节机制，</span><code>recv buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">的实际大小会自动在最小值和最大值之间浮动，以期找到性能和资源的平衡点，因此大多数情况下不建议将</span><code>recv buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">手工设置成固定值。</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">当</span><code>net.ipv4.tcp_moderate_rcvbuf</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px; background-color:">设置为1时，自动调节机制生效，每个TCP连接的recv Buffer由下面的3元数组指定：</span></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_rmem =   </span><br></pre></td></tr></table></figure>

<p>最初<code>recv buffer</code>被设置为，同时这个缺省值会覆盖<code>net.core.rmem_default</code>的设置。随后<code>recv buffer</code>根据实际情况在最大值和最小值之间动态调节。在缓冲的动态调优机制开启的情况下，我们将<code>net.ipv4.tcp_rmem</code>的最大值设置为<code>BDP</code>。</p>
<p>当<code>net.ipv4.tcp_moderate_rcvbuf</code>被设置为0，或者设置了socket选项<code>SO_RCVBUF</code>，缓冲的动态调节机制被关闭。<code>recv buffer</code>的缺省值由<code>net.core.rmem_default</code>设置，但如果设置了<code>net.ipv4.tcp_rmem</code>，缺省值则被覆盖。可以通过系统调用setsockopt()设置<code>recv buffer</code>的最大值为<code>net.core.rmem_max</code>。在缓冲动态调节机制关闭的情况下，建议把缓冲的缺省值设置为<code>BDP</code>。</p>
<p>注意这里还有一个细节，缓冲除了保存接收的数据本身，还需要一部分空间保存socket数据结构等额外信息。因此上面讨论的<code>recv buffer</code>最佳值仅仅等于<code>BDP</code>是不够的，还需要考虑保存socket等额外信息的开销。Linux根据参数<code>net.ipv4.tcp_adv_win_scale</code>计算额外开销的大小：</p>
<p><img data-src="http://img4.tbcdn.cn/L1/461/1/29e441e2417f14038a2b80fe797124f01960e158"></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">如果</span><code>net.ipv4.tcp_adv_win_scale</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">的值为1，则二分之一的缓冲空间用来做额外开销，如果为2的话，则四分之一缓冲空间用来做额外开销。因此</span><code>recv buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">的最佳值应该设置为：</span></p>
<p><img data-src="http://img4.tbcdn.cn/L1/461/1/1c6cb73c7ca060b6c1dac825f60dcd5e03d5238b"></p>
<p>三、数据包的发送</p>
<p>发送数据包经过的路径：</p>
<p><img data-src="http://img4.tbcdn.cn/L1/461/1/21a3ebef1dadd6d18d982eb3a325dd6075ef14e4"></p>
<p>和接收数据的路径相反，数据包的发送从上往下也经过了三层：用户态空间的应用、系统内核空间、最后到网卡驱动。应用先将数据写入TCP&amp;nbsp;<wbr /><code>send buffer</code>，TCP层将<code>send buffer</code>中的数据构建成数据包转交给IP层。IP层会将待发送的数据包放入队列<code>QDisc</code>(queueing discipline)。数据包成功放入<code>QDisc</code>后，指向数据包的描述符<code>sk_buff</code>被放入<code>Ring Buffer</code>输出队列，随后网卡驱动调用<code>DMA engine</code>将数据发送到网络链路上。</p>
<p>同样我们逐层来梳理队列缓冲有关的参数。</p>
<p><span style="word-wrap: normal; word-break: normal; line-height: 24px; font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; box-sizing: border-box; font-weight: 700;">1.send Buffer</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">同</span><code>recv Buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">类似，和</span><code>send Buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">有关的参数如下：</span></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_wmem =   </span><br><span class="line">net.core.wmem_default</span><br><span class="line">net.core.wmem_max</span><br></pre></td></tr></table></figure>

<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">发送端缓冲的自动调节机制很早就已经实现，并且是无条件开启，没有参数去设置。如果指定了</span><code>tcp_wmem</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">，则</span><code>net.core.wmem_default</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">被</span><code>tcp_wmem</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">的覆盖。</span><code>send Buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">在</span><code>tcp_wmem</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">的最小值和最大值之间自动调节。如果调用</span><code>setsockopt()</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">设置了socket选项</span><code>SO_SNDBUF</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">，将关闭发送端缓冲的自动调节机制，</span><code>tcp_wmem</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">将被忽略，</span><code>SO_SNDBUF</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">的最大值由</span><code>net.core.wmem_max</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">限制。</span></p>
<p><span style="word-wrap: normal; word-break: normal; line-height: 24px; font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; box-sizing: border-box; font-weight: 700;">2.QDisc</span></p>
<p><code>QDisc</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">（queueing discipline ）位于IP层和网卡的</span><code>ring buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">之间。我们已经知道，</span><code>ring buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">是一个简单的FIFO队列，这种设计使网卡的驱动层保持简单和快速。而</span><code>QDisc</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">实现了流量管理的高级功能，包括流量分类，优先级和流量整形（rate-shaping）。可以使用</span><code>tc</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">命令配置</span><code>QDisc</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">。</span></p>
<p><code>QDisc</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">的队列长度由</span><code>txqueuelen</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">设置，和接收数据包的队列长度由内核参数</span><code>net.core.netdev_max_backlog</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">控制所不同，</span><code>txqueuelen</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">是和网卡关联，可以用</span><code>ifconfig</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">命令查看当前的大小：</span></p>
<p><img data-src="http://img1.tbcdn.cn/L1/461/1/6dcf86b5eb148f95d5ea7d64f698734b9b9cd7f3"></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">使用</span><code>ifconfig</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">调整</span><code>txqueuelen</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">的大小：</span></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifconfig eth0 txqueuelen 2000</span><br></pre></td></tr></table></figure>

<p><span style="word-wrap: normal; word-break: normal; line-height: 24px; font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; box-sizing: border-box; font-weight: 700;">3.Ring Buffer</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">和数据包的接收一样，发送数据包也要经过</span><code>Ring Buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">，使用</span><code>ethtool -g eth0</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">查看：</span></p>
<p><img data-src="http://img1.tbcdn.cn/L1/461/1/2e7a9a3a5da675786312e6eefbf0b5959b4be130"></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">其中</span><code>TX</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">项是</span><code>Ring Buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">的传输队列，也就是发送队列的长度。设置也是使用命令</span><code>ethtool -G</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">。</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; font-weight: bold; line-height: 24px;">4.TCP Segmentation和Checksum Offloading</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">操作系统可以把一些TCP&#x2F;IP的功能转交给网卡去完成，特别是Segmentation(分片)和checksum的计算，这样可以节省CPU资源，并且由硬件代替OS执行这些操作会带来性能的提升。</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">一般以太网的</span><code>MTU</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">（Maximum Transmission Unit）为1500 bytes，假设应用要发送数据包的大小为7300bytes，</span><code>MTU</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">1500字节 － IP头部20字节 － TCP头部20字节＝有效负载为1460字节，因此7300字节需要拆分成5个segment：</span></p>
<p><img data-src="http://img1.tbcdn.cn/L1/461/1/f95a88bc6e0327c1173f4736d881ab3e531f9e21"></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">Segmentation(分片)操作可以由操作系统移交给网卡完成，虽然最终线路上仍然是传输5个包，但这样节省了CPU资源并带来性能的提升：</span></p>
<p><img data-src="http://img2.tbcdn.cn/L1/461/1/fae4d502f54dea93565e0facd4fb9686e27d16de"></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">可以使用</span><code>ethtool -k eth0</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">查看网卡当前的offloading情况：</span></p>
<p><img data-src="http://img4.tbcdn.cn/L1/461/1/b682793c235a93fe9a588c7892895659bbdd4111"></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">上面这个例子checksum和tcp segmentation的offloading都是打开的。如果想设置网卡的offloading开关，可以使用</span><code>ethtool -K</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">(注意K是大写)命令，例如下面的命令关闭了tcp segmentation offload：</span></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ethtool -K eth0 tso off</span><br></pre></td></tr></table></figure>

<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; font-weight: bold; line-height: 24px;">5.网卡多队列和网卡Bonding模式</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">在数据包的接收过程中已经介绍过了</span><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">。</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; letter-spacing: 0.479999989271164px; line-height: 27px; ">至此，终于梳理完毕。整理TCP队列相关参数的起因是最近在排查一个网络超时问题，原因还没有找到，产生的&amp;ldquo;副作用&amp;rdquo;就是这篇文档。再想深入解决这个问题可能需要做TCP协议代码的profile，需要继续学习，希望不久的将来就可以再写文档和大家分享了。</span></p>
<p>&amp;nbsp;</p>
<p><span style="word-wrap: normal; word-break: normal; line-height: 24px; font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; letter-spacing: 0.479999989271164px; box-sizing: border-box; font-weight: 700;">参考文档</span></p>
<p><a target="_blank" rel="noopener" href="http://www.linuxjournal.com/content/queueing-linux-network-stack">Queueing in the Linux Network Stack</a></p>
<p><a target="_blank" rel="noopener" href="http://www.ece.virginia.edu/cheetah/documents/papers/TCPlinux.pdf">TCP Implementation in Linux: A Brief Tutorial</a></p>
<p><a target="_blank" rel="noopener" href="http://sandilands.info/sgordon/impact-of-bandwidth-delay-product-on-tcp-throughput">Impact of Bandwidth Delay Product on TCP Throughput</a></p>
<p><a target="_blank" rel="noopener" href="http://hellojava.info/?p=292">Java程序员也应该知道的系统知识系列之网卡</a></p>
<p><a target="_blank" rel="noopener" href="http://hellojava.info/?p=238">说说网卡中断处理</a></p>
<p>&amp;nbsp;</p>
<p>原文链接：<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_e59371cc0102vg4n.html">http://blog.sina.com.cn/s/blog_e59371cc0102vg4n.html</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Linux/" rel="tag"># Linux</a>
              <a href="/tags/%E8%BD%AC%E8%BD%BD%E5%AD%A6%E4%B9%A0/" rel="tag"># 转载学习</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2015/04/01/technical-story-behind-the-spring-festival-weibo.html" rel="prev" title="微博春晚背后的技术故事">
                  <i class="fa fa-chevron-left"></i> 微博春晚背后的技术故事
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2015/05/09/zabbix-post-a-mail.html" rel="next" title="zabbix邮件告警设置">
                  zabbix邮件告警设置 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">皖ICP备15000396号-1 </a>
  </div>

<div class="copyright">
  &copy; 2012 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yvan</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/yvanz" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/fancybox.js"></script>



  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"yvanz","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
