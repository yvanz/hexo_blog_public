<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CPT+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.yvanz.com","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.17.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"style":null,"show_result":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="若当初的你，和现在的我，可以重来过">
<meta property="og:type" content="website">
<meta property="og:title" content="Yvanの平行时空">
<meta property="og:url" content="https://www.yvanz.com/page/3/index.html">
<meta property="og:site_name" content="Yvanの平行时空">
<meta property="og:description" content="若当初的你，和现在的我，可以重来过">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Yvan">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.yvanz.com/page/3/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/3/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Yvanの平行时空</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Yvanの平行时空</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Yvan"
      src="https://statics.yvanz.com/avatar.jpg">
  <p class="site-author-name" itemprop="name">Yvan</p>
  <div class="site-description" itemprop="description">若当初的你，和现在的我，可以重来过</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">60</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/yvanz" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;yvanz" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/n/Yvan_OPS" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;n&#x2F;Yvan_OPS" rel="noopener me" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
          链接
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <a href="http://www.bnard.cn/" title="http:&#x2F;&#x2F;www.bnard.cn&#x2F;" rel="noopener" target="_blank">BnArD</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="http://hustcat.github.io/" title="http:&#x2F;&#x2F;hustcat.github.io&#x2F;" rel="noopener" target="_blank">YY哥</a>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.yvanz.com/2015/08/19/the-fault.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://statics.yvanz.com/avatar.jpg">
      <meta itemprop="name" content="Yvan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yvanの平行时空">
      <meta itemprop="description" content="若当初的你，和现在的我，可以重来过">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Yvanの平行时空">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/08/19/the-fault.html" class="post-title-link" itemprop="url">The Fault</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-08-19 22:54:12" itemprop="dateCreated datePublished" datetime="2015-08-19T22:54:12+08:00">2015-08-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%96%87%E8%89%BA%E8%8C%83/" itemprop="url" rel="index"><span itemprop="name">文艺范</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2015/08/19/the-fault.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/08/19/the-fault.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img data-src="https://statics.yvanz.com/the-fault-1.jpg"></p>
<p>灯光暗灭，前奏响起。那场执念多年的演唱会终于拉开了帷幕。</p>
<p>如我在开场时发的微博，那天虽然忙碌，可是安心坐下来的时候仍然怀疑他在合肥的演唱会真的能开始了吗，这场景本应存在于梦里才对。</p>
<p>演唱会当天仍然不可避免的忙碌。虽淡出许久，可是对于安徽的活动总是有些牵挂。而至于这份牵挂的由来，可能要追溯回2010年跟小伙伴们相识的年份吧。那一年的一场商演，我误打误撞的认识了那样的一群人。那时候的安徽分会，也在那群人秉承着的某种意志下建立起来了。</p>
<p>虽然那一年的商演最后由他的一句“不见不散”，变成了“因病缺席”。可是这一群人却变成了我年少时期几乎所有幸福的源头。于是他们所坚守的“安徽”也渐渐成为了我的执念。</p>
<p>故事的开头总是美好的，故事的结局也总是被想象的很美好。原本大家约定安排妥当后借着一场活动完美告别。可是因为一些不解与愤慨，最后这场告别以一群人的裸退收场。而当我面对这样一个大家曾经那么用心经营的地方时，心里却满满的惋惜。想着让它茁壮成长下去才对得起他们那么多年那么多的用心吧。虽然刚开始的那半年忍受过多不解，可是最后也算坚持下来了。而且经过这场演唱会的验收，的确现在那些年轻的孩子们已经做的很棒很让人欣慰了。</p>
<p>记得在这场演唱会只是公布行程的时候，就期待着能在奥体举办。因为他对这座场馆说过太多次的“不见不散”，但最终又因为各种说辞未能如约。甚至这场演唱会在开始前的一个月，都因为主办与经济公司之间的沟通不悦差点夭折，所以格外珍惜着最终的时线。更何况我曾听过从这座场馆里拨出的那么暖心连线的五月天，亲眼见过满场粉海的周杰伦，所以对于能在这里看到紫海便更加执念。</p>
<p>所谓圆梦与遗憾，大体是人生里面最磨人的小妖精了吧。这场看似圆梦的演唱会，也因为一些遗憾，让我更深刻的纪念着。</p>
<p><img data-src="https://statics.yvanz.com/the-fault-2.jpg"></p>
<p>嗯，也谢谢今天所有的生日快乐。Love U U.</p>
<iframe border="0" frameborder="no" height="86" marginheight="0" marginwidth="0" src="http://music.163.com/outchain/player?type=2&amp;id=29850682&amp;auto=1&amp;height=66" width="330"></iframe>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.yvanz.com/2015/08/01/half-year-note.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://statics.yvanz.com/avatar.jpg">
      <meta itemprop="name" content="Yvan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yvanの平行时空">
      <meta itemprop="description" content="若当初的你，和现在的我，可以重来过">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Yvanの平行时空">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/08/01/half-year-note.html" class="post-title-link" itemprop="url">半年记</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-08-01 23:11:54" itemprop="dateCreated datePublished" datetime="2015-08-01T23:11:54+08:00">2015-08-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%96%87%E8%89%BA%E8%8C%83/" itemprop="url" rel="index"><span itemprop="name">文艺范</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2015/08/01/half-year-note.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/08/01/half-year-note.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <iframe border="0" frameborder="no" height="86" marginheight="0" marginwidth="0" src="http://music.163.com/outchain/player?type=2&amp;id=27560017&amp;auto=1&amp;height=66" width="330"></iframe>

<p>如我六月初申请离职时谈到的，自己总是一个对时间点比较在意的人：上半年的决定，总是希望能在上半年结束掉。所以很感激合肥公司的领导能理解我的固执，在六月的尾巴帮我成功离职了。</p>
<p>说到这家合肥的公司，我总是抱以最大的期许希望她能成功。因为我希望我的合肥有更多说得上的互联网公司（乐堂就不提了，瞧不上之）；因为我曾参与其中，亲眼见证了一个产品诞生路上的坎坷。我也庆幸自己曾参与于这样一个创业团队，在这里我实实在在的开拓了视野。虽然因为自己个人的原因中途从中掉队，但离开后却不妨碍我祝福她。而最真切的祝福大概就是希望她发展的好到我以后会为我当下的决定后悔吧。</p>
<p>每天无事可做但工资尚可的上半年，自己陷入了一个很惶恐的心境。而从合肥离职后，算是结束了这样的生活。可能自己生来就是工作狂吧，竟发现13年在上海时，每天自己留下来加班的生活是最让自己热血沸腾的时候。所以赋闲下来之后，当上海的领导来找我时，我犹豫了一些日子最终答应了重新回来折腾一番。</p>
<p>回来的这段时间，果不其然有满满的工作安排，尤记得入职第一天面临扑面而来的任务时，内心亢奋的感觉，用一句话比喻就像是天晴了雨停了感觉自己又行了。就像后来调侃似的说，在这里两个星期做的事情，完全相当于在合肥待两年做的事情。只不过这里的忙碌也剥夺了平时学习的时间和热情，而且在推进工作计划过程中还会因为一些突发事件打乱自己的节奏。目前更多的是感觉自己像个消防员，工作起来还是很被动，没办法专注于自己的计划。希望接下来能适应这种节奏，然后看能不能改变公司现在面临的这种尴尬，不能总想着灭火才是。而对于另一个回来的原因，希望自己能如当初跟朋友聊天时所说的那样，保留好最初的想法，希望不会因为冲动而坏了念想。</p>
<p>寡欢清淡的上半年，和可想而知充实到死的下半年。这样的本命年还真的是让人印象深刻，也希望下一个本命年能因为现在的决定而变得更不一样。</p>
<p>2015.08.01</p>
<p>于上海</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.yvanz.com/2015/07/16/local-yumrepo.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://statics.yvanz.com/avatar.jpg">
      <meta itemprop="name" content="Yvan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yvanの平行时空">
      <meta itemprop="description" content="若当初的你，和现在的我，可以重来过">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Yvanの平行时空">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/07/16/local-yumrepo.html" class="post-title-link" itemprop="url">本地YUM源</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-07-16 10:35:52" itemprop="dateCreated datePublished" datetime="2015-07-16T10:35:52+08:00">2015-07-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF%E5%AE%85/" itemprop="url" rel="index"><span itemprop="name">技术宅</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2015/07/16/local-yumrepo.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/07/16/local-yumrepo.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>建立本地YUM源的初衷是按照自己的需求打包rpm包并在内网装机时直接部署。所以先来介绍一下RPM包的打包工具，我选择的是FPM来打包。</p>
<p>FPM on&amp;nbsp;github：<a target="_blank" rel="noopener" href="https://github.com/jordansissel/fpm">https://github.com/jordansissel/fpm</a></p>
<p>FPM安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#FPM基于ruby开发，所以先yum安装ruby以及rubygems</span></span><br><span class="line">yum install ruby rubygems ruby-devel ruby-rdoc rpm-build gcc -y</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除默认RubyGems源并添加使用淘宝的RubyGems源</span></span><br><span class="line">gem sources --remove http://rubygems.org/</span><br><span class="line">gem sources -a https://ruby.taobao.org/</span><br><span class="line">gem sources -l</span><br><span class="line">*** CURRENT SOURCES ***</span><br><span class="line"></span><br><span class="line">https://ruby.taobao.org</span><br><span class="line"><span class="comment"># 请确保只有 ruby.taobao.org</span></span><br><span class="line"></span><br><span class="line">gem install fpm  <span class="comment">#使用gem安装fpm</span></span><br></pre></td></tr></table></figure>

<p>FPM使用编译好的软件目录打包RPM，所以在打包之前，需要先编译好软件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">FPM常用打包命令解析（更多命令请fpm --<span class="built_in">help</span>）：</span><br><span class="line">fpm -s <span class="built_in">dir</span> \  <span class="comment">#定义导入的是何种类型</span></span><br><span class="line">-t rpm \  <span class="comment">#定义输出的包是何种类型</span></span><br><span class="line">-n smm-nginx \  <span class="comment">#定义包的名称</span></span><br><span class="line">-v 1.8.0 \  <span class="comment">#定义版本信息</span></span><br><span class="line">--iteration 1 \  <span class="comment">#定义周期版本号</span></span><br><span class="line">-d <span class="string">&#x27;pcre &gt;= 7.8&#x27;</span> \  <span class="comment">#定义依赖，可多次使用该参数</span></span><br><span class="line">-d <span class="string">&#x27;pcre-static &gt;= 7.8&#x27;</span> \</span><br><span class="line">-d <span class="string">&#x27;pcre-devel &gt;= 7.8&#x27;</span> \</span><br><span class="line">-d <span class="string">&#x27;openssl-perl &gt;= 1.0.1e&#x27;</span> \</span><br><span class="line">-d <span class="string">&#x27;openssl-static &gt;= 1.0.1e&#x27;</span> \</span><br><span class="line">-d <span class="string">&#x27;openssl &gt;= 1.0.1e&#x27;</span> \</span><br><span class="line">-d <span class="string">&#x27;openssl-devel &gt;= 1.0.1e&#x27;</span> \</span><br><span class="line">-d <span class="string">&#x27;openssl098e &gt;= 0.9.8e&#x27;</span> \</span><br><span class="line">-m  \  <span class="comment">#定义维护者，一般留邮箱</span></span><br><span class="line">--vendor SMM IT \  <span class="comment">#定义RPM包的提供者</span></span><br><span class="line">--description SMM Nginx Version \  <span class="comment">#定义包的描述</span></span><br><span class="line">--url http://www.smm.cn \  <span class="comment">#定义链接</span></span><br><span class="line">--before-install pre-nginx.sh \  <span class="comment">#定义安装前运行的脚本，按需添加（此处需使用完整路径）</span></span><br><span class="line">--after-remove \  <span class="comment">#定义卸载后运行的脚本，按需添加（此处需使用完整路径）</span></span><br><span class="line">--rpm-init nginx \  <span class="comment">#定义安装后需要键入系统服务的运行脚本，按需添加（此处需使用完整路径）</span></span><br><span class="line">/usr/local/webserver/nginx/  <span class="comment">#定义编译后的程序路径</span></span><br></pre></td></tr></table></figure>

<p>有了自定义的RPM之后，就可以自建本地yum源了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install createrepo -y</span><br><span class="line">createrepo -p -d -o /yum/Packages/ /yum/Packages/   <span class="comment">#新建源</span></span><br><span class="line">createrepo --update /yum/Packages   <span class="comment">#更新源</span></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.yvanz.com/2015/06/02/lvs-info-lvs-web.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://statics.yvanz.com/avatar.jpg">
      <meta itemprop="name" content="Yvan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yvanの平行时空">
      <meta itemprop="description" content="若当初的你，和现在的我，可以重来过">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Yvanの平行时空">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/06/02/lvs-info-lvs-web.html" class="post-title-link" itemprop="url">LVS详解及基于LVS实现web服务器负载均衡</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-06-02 17:30:48" itemprop="dateCreated datePublished" datetime="2015-06-02T17:30:48+08:00">2015-06-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF%E5%AE%85/" itemprop="url" rel="index"><span itemprop="name">技术宅</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2015/06/02/lvs-info-lvs-web.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/06/02/lvs-info-lvs-web.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>LVS(Linux Virtual Server)Linux虚拟服务器，是一个虚拟的服务器集群系统。本项目在1998年5月由章文嵩博士成立，是中国国内最早出现的自由软件项目之一。通过LVS提供的负载均衡技术和Linux操作系统可实现一个高性能、高可用的服务器群集，从而以低成本实现最优的服务性能。</p>
<h2 id="集群基础"><a href="#集群基础" class="headerlink" title="集群基础"></a>集群基础</h2><h3 id="集群简介"><a href="#集群简介" class="headerlink" title="集群简介"></a>集群简介</h3><p>集群(Cluster)是一组相互独立的、通过高速网络互联的计算机，它们构成了一个组，并以单一系统的模式加以管理。一个客户与集群相互作用时，集群像是一个独立的服务器。集群配置是用于提高可用性和可缩放性。集群系统的主要优点：高可扩展性、高可用性、高性能、高性价比。</p>
<h3 id="集群类型"><a href="#集群类型" class="headerlink" title="集群类型"></a>集群类型</h3><p>LB：Load Balancing 高可拓展，伸缩集群<br>HA：High Availability 高可用集群<br>HP：High Performance 高性能集群</p>
<h3 id="集群方案"><a href="#集群方案" class="headerlink" title="集群方案"></a>集群方案</h3><p>LB：<br>硬件级：F5 BIG-IP、Citrix Netscaler、 A10 A10、Array、Redware<br>软件级：lvs (传输层)、haproxy, nginx (应用层)</p>
<p>HA：<br>heartbeat 、corosync + pacemaker、 cman + rgmanager、cman + pacemaker、keepalived</p>
<p>HP:<br>hadoop</p>
<h2 id="LVS详解"><a href="#LVS详解" class="headerlink" title="LVS详解"></a>LVS详解</h2><h3 id="LVS组成"><a href="#LVS组成" class="headerlink" title="LVS组成"></a>LVS组成</h3><p>ipvsadm：用于管理集群服务的命令行工具，工作于Linux系统中的用户空间。<br>ipvs：为lvs提供服务的内核模块，工作于内核空间</p>
<h3 id="LVS术语"><a href="#LVS术语" class="headerlink" title="LVS术语"></a>LVS术语</h3><p>VIP：Director用来向外部提供服务的IP地址,也就是DNS通过域名解析到的IP<br>RIP：集群节点（后台真正提供服务的服务器）所使用的IP地址<br>DIP：Director用来和RIP进行交互的IP地址<br>CIP：客户端使用的IP或公网IP<br>RS:集群节点服务器Real server</p>
<h3 id="LVS类型"><a href="#LVS类型" class="headerlink" title="LVS类型"></a>LVS类型</h3><p>LVS-NAT：Network Address Translation 网络地址转换<br>LVS-DR：Direct Routing 直连路由<br>LVS-TUN：Tunneling 隧道</p>
<h3 id="LVS各类型特性"><a href="#LVS各类型特性" class="headerlink" title="LVS各类型特性"></a>LVS各类型特性</h3><p>NAT类型的特性：<br>①RS应用使用私有地址，RS的网关必须指向DIP<br>②请求和响应都要经过Director，高负载场景中，Director易成为性能瓶颈<br>③支持端口映射<br>④RS可以使用任意OS</p>
<p>DR类型的特性：<br>①保证前端路由将目标地址为VIP的报文统统发往Directory，而不能是RS<br>解决方案：<br>(1) 静态地址绑定：在前端路由器上操作<br>前提：必须要有路由操作权限<br>(2) aprtables<br>(3) 修改RS上内核参数，将RS上的VIP配置在lo接口的别名上，并限制其不能响应对VIP地址解析请求</p>
<p>②RS可以使用私有地址，但也可以使用公网地址，此时可通过互联网通过RIP对其直接访问<br>③RS跟Directory必须在同一物理网络中<br>④请求报文经由Director，但响应报文必须不能经过Director<br>⑤不支持端口映射<br>⑥RS可以是大多数常见的OS<br>⑦RS的网关绝不允许指向DIP</p>
<p>TUN类型的特性:<br>①RIP、VIP、DIP全部是公网地址<br>②RS的网关不会也不可能指向DIP<br>③请求报文经由Director，但响应报文必须不能经过Director<br>④不支持端口映射<br>⑤RS的OS必须支持隧道功能</p>
<h3 id="LVS调度算法"><a href="#LVS调度算法" class="headerlink" title="LVS调度算法"></a>LVS调度算法</h3><p>静态方法：仅根据调度算法本身进行调度</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rr: round robin，轮流，轮询，轮叫</span><br><span class="line">wrr: weighted round robin, 加权轮询</span><br><span class="line">sh：<span class="built_in">source</span> hashing，session绑定</span><br><span class="line">dh: destination hashing, 目标地址<span class="built_in">hash</span></span><br></pre></td></tr></table></figure>

<p>动态方法：根据算法及各RS当前的负载状况进行调度</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lc: least connection，最少连接</span><br><span class="line">wlc: weighted lc，加权最少连接</span><br><span class="line">sed: shortest expection delay，最少期望延迟</span><br><span class="line">nq: never queue，永不排队</span><br><span class="line">lblc: Locality-Based Least Connection，基于局部性的最少连接</span><br><span class="line">lblcr：Replicated lblc，基于局部性的带复制功能的最少连接</span><br></pre></td></tr></table></figure>

<h3 id="LVS配置（ipvsadm）"><a href="#LVS配置（ipvsadm）" class="headerlink" title="LVS配置（ipvsadm）"></a>LVS配置（ipvsadm）</h3><p>命令格式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -A|E -t|u|f service-address [-s scheduler]</span><br><span class="line">              [-p [<span class="built_in">timeout</span>]] [-M netmask]</span><br><span class="line">      ipvsadm -D -t|u|f service-address</span><br><span class="line">      ipvsadm -C</span><br><span class="line">      ipvsadm -R</span><br><span class="line">      ipvsadm -S [-n]</span><br><span class="line">      ipvsadm -a|e -t|u|f service-address -r server-address</span><br><span class="line">              [-g|i|m] [-w weight] [-x upper] [-y lower]</span><br><span class="line">      ipvsadm -d -t|u|f service-address -r server-address</span><br><span class="line">      ipvsadm -L|l [options]</span><br><span class="line">      ipvsadm -Z [-t|u|f service-address]</span><br><span class="line">      ipvsadm --<span class="built_in">set</span> tcp tcpfin udp</span><br><span class="line">      ipvsadm --start-daemon state [--mcast-interface interface]</span><br><span class="line">              [--syncid syncid]</span><br><span class="line">      ipvsadm --stop-daemon state</span><br><span class="line">      ipvsadm -h</span><br></pre></td></tr></table></figure>

<p>命令详解</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">定义集群服务：</span><br><span class="line"></span><br><span class="line">-A 添加一个集群服务</span><br><span class="line">-D 删除一个集群服务 </span><br><span class="line">-E 修改一个集群服务</span><br><span class="line">-t VIP:端口 定义集群服务的类型为TCP的某个端口</span><br><span class="line">-u VIP:端口 定义集群服务的类型为UDP的某个端口</span><br><span class="line">-f 防火墙标记 定义集群服务的类型为防火墙标记</span><br><span class="line">-s 调度算法 指定集群服务的调度算法 </span><br><span class="line">定义集群节点：</span><br><span class="line">-a 添加一个节点到集群服务</span><br><span class="line">-d 从集群服务中删除一个节点</span><br><span class="line">-e 修改集群服务器中的节点</span><br><span class="line">-r 节点IP:端口  定义节点的IP及类型</span><br><span class="line">-m 定义为NAT模型</span><br><span class="line">-g 定义为DR模型</span><br><span class="line">-i 定义为TUN模型</span><br><span class="line">-w 权重 定义服务器的权重</span><br><span class="line">查看已经定义的集群服务及RS：</span><br><span class="line">ipvsadm -L -n</span><br><span class="line">    -c: 查看各连接</span><br><span class="line">    --stats: 统计数据</span><br><span class="line">    --rate:　速率</span><br><span class="line">    --exact: 精确值</span><br><span class="line">从集群服务中删除RS：</span><br><span class="line">ipvsadm -d -t|u|f service-address -r server-address</span><br><span class="line">删除集群服务：</span><br><span class="line">ipvsadm -D -t|u|f service-address</span><br><span class="line">清空所有的集群服务：</span><br><span class="line">ipvsadm -C </span><br><span class="line">保存集群服务定义：</span><br><span class="line">ipvsadm -S &amp;gt; /path/to/some_rule_file</span><br><span class="line">ipvsadm-save &amp;gt; /path/to/some_rule_file</span><br><span class="line">让规则文件中的规则生效：</span><br><span class="line">ipvsadm -R &amp;lt; /path/from/some_rule_file</span><br><span class="line">ipvsadm-restore &amp;lt; /path/from/some_rule_file</span><br></pre></td></tr></table></figure>

<h4 id="LVS-NAT模型"><a href="#LVS-NAT模型" class="headerlink" title="LVS-NAT模型"></a>LVS-NAT模型</h4><p><img data-src="http://www.178linux.com/ueditor/php/upload/image/20150528/1432806434701926.jpg"></p>
<p>配置过程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#以下实验都是临时性配置，若要永久生效，请自行配置</span></span><br><span class="line"></span><br><span class="line">Real Server 1</span><br><span class="line"><span class="comment">#ifconfig eth0 172.16.10.100/16 up</span></span><br><span class="line"><span class="comment">#route add default gw 172.16.10.12</span></span><br><span class="line">Real Server 2</span><br><span class="line"><span class="comment">#ifconfig eth0 172.16.10.212/16 up</span></span><br><span class="line"><span class="comment">#route add default gw 172.16.10.12</span></span><br><span class="line">Director Server</span><br><span class="line"><span class="comment">#ifconfig eth0 192.168.1.10/24 up</span></span><br><span class="line"><span class="comment">#ifconfig eth1 172.16.10.12/16 up</span></span><br><span class="line"><span class="comment">#yum -y install ipvsadm </span></span><br><span class="line"><span class="comment">#echo 1 &amp;gt; /proc/sys/net/ipv4/ip_forward</span></span><br><span class="line"><span class="comment">#ipvsadm -A -t 192.168.1.10:80 -s rr</span></span><br><span class="line"><span class="comment">#ipvsadm -a -t 192.168.1.10:80 -r 172.16.10.100 -m </span></span><br><span class="line"><span class="comment">#ipvsadm -a -t 192.168.1.10:80 -r 172.16.10.212 -m</span></span><br></pre></td></tr></table></figure>

<h4 id="LVS-DR模型"><a href="#LVS-DR模型" class="headerlink" title="LVS-DR模型"></a>LVS-DR模型</h4><p>上面说了NAT模型的实现方式,但NAT模型有个缺陷,因为进出的每个数据包都要经过Director Server,当集群系统负载过大的时候Director Server将会成为整个集群系统的瓶颈,而DR模型就避免了这样的情况发生,DR模型在只有请求的时候才会经过Director Server, 回应的数据包由Real Server 直接响应用户不需要经过Director Server。</p>
<p><img data-src="http://www.178linux.com/ueditor/php/upload/image/20150528/1432806463110648.jpg"></p>
<p>配置过程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">内核参数：</span><br><span class="line">arp_ignore: 定义接收到ARP请求时的响应级别</span><br><span class="line">0：只要本地配置的有相应地址，就给予响应</span><br><span class="line">1：仅在请求的目标地址配置请求到达的接口上的时候，才给予响应</span><br><span class="line">arp_announce：定义将自己地址向外通告时的通告级别</span><br><span class="line">0：将本地任何接口上的任何地址向外通告</span><br><span class="line">1：试图仅向目标网络通告与其网络匹配的地址</span><br><span class="line">2：仅向与本地接口上地址匹配的网络进行通告</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Real Server 1</span><br><span class="line"><span class="comment">#ifconfig eth0 172.16.10.100/16 up</span></span><br><span class="line"><span class="comment">#echo 1 &amp;gt; /proc/sys/net/ipv4/conf/eth0/arp_ignore</span></span><br><span class="line"><span class="comment">#echo 1 &amp;gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span></span><br><span class="line"><span class="comment">#echo 2 &amp;gt; /proc/sys/net/ipv4/conf/all/arp_announce</span></span><br><span class="line"><span class="comment">#echo 2 &amp;gt; /proc/sys/net/ipv4/conf/eth0/arp_announce</span></span><br><span class="line"><span class="comment">#ifconfig lo:0 192.168.1.10 netmask 255.255.255.255 broadcast 192.168.1.10 up</span></span><br><span class="line"><span class="comment">#route add -host 192.168.1.10 dev lo:0</span></span><br><span class="line">Real Server 2</span><br><span class="line"><span class="comment">#ifconfig eth0 172.16.10.212/16 up</span></span><br><span class="line"><span class="comment">#echo 1 &amp;gt; /proc/sys/net/ipv4/conf/eth0/arp_ignore</span></span><br><span class="line"><span class="comment">#echo 1 &amp;gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span></span><br><span class="line"><span class="comment">#echo 2 &amp;gt; /proc/sys/net/ipv4/conf/all/arp_announce</span></span><br><span class="line"><span class="comment">#echo 2 &amp;gt; /proc/sys/net/ipv4/conf/eth0/arp_announce</span></span><br><span class="line"><span class="comment">#ifconfig lo:0 192.168.1.10 netmask 255.255.255.255 broadcast 192.168.1.10 up</span></span><br><span class="line"><span class="comment">#route add -host 192.168.1.10 dev lo:0</span></span><br><span class="line">Director Server</span><br><span class="line"><span class="comment">#ifconfig eth0 172.16.10.12/16 up</span></span><br><span class="line"><span class="comment">#ifconfig eth0:0 192.168.1.10 netmask 255.255.255.255 broadcast 192.168.1.10 up</span></span><br><span class="line"><span class="comment">#echo 1 &amp;gt; /proc/sys/net/ipv4/ip_forward</span></span><br><span class="line"><span class="comment">#route add -host 192.168.1.10 dev eth0:0</span></span><br><span class="line"><span class="comment">#yum install ipvsadm -y</span></span><br><span class="line"><span class="comment">#ipvsadm -A -t 192.168.1.10:80 -s rr</span></span><br><span class="line"><span class="comment">#ipvsadm -a -t 192.168.1.10:80 -r 172.16.10.100 -g </span></span><br><span class="line"><span class="comment">#ipvsadm -a -t 192.168.1.10:80 -r 172.16.10.212 -g</span></span><br></pre></td></tr></table></figure>

<h3 id="基于LVS实现web服务器负载均衡"><a href="#基于LVS实现web服务器负载均衡" class="headerlink" title="基于LVS实现web服务器负载均衡"></a>基于LVS实现web服务器负载均衡</h3><p>实验拓扑</p>
<p><img data-src="http://www.178linux.com/ueditor/php/upload/image/20150528/1432806487139117.jpg"></p>
<p>环境介绍</p>
<p>系统环境：CentOS6.6<br>Director Server：192.168.1.10（VIP） 172.16.10.12（DIP）<br>Real Server 1:192.168.1.10（VIP） 172.16.10.100（RIP）<br>Real Server 2:192.168.1.10（VIP） 172.16.10.212（RIP）</p>
<p>PHP服务器：172.16.10.110&amp;nbsp;</p>
<p>NFS服务器：172.16.10.110</p>
<p>数据库服务器：172.16.10.211</p>
<p>要求：web服务器上部署discuz，基于LVS实现负载均衡</p>
<p>NFS服务器配置</p>
<p>创建共享目录，并设置权限</p>
<p><img data-src="http://www.178linux.com/ueditor/php/upload/image/20150528/1432806508793147.jpg"></p>
<p>编辑配置文件，设置共享目录及客户端</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@scholar ~]<span class="comment"># vim /etc/exports </span></span><br><span class="line">/web/discuz     172.16.10.100(rw,<span class="built_in">sync</span>) 172.16.10.212(rw,<span class="built_in">sync</span>)</span><br></pre></td></tr></table></figure>

<p>站点文件准备</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@scholar ~]<span class="comment"># unzip Discuz_7.2_FULL_SC_GBK.zip</span></span><br><span class="line">[root@scholar ~]<span class="comment"># chmod -R 777 upload </span></span><br><span class="line">[root@scholar ~]<span class="comment"># mv upload/* /web/discuz/</span></span><br><span class="line">[root@scholar ~]<span class="comment"># chown -R apache.apache /web/discuz</span></span><br></pre></td></tr></table></figure>

<p>启动服务，设置开机自启</p>
<p><img data-src="http://www.178linux.com/ueditor/php/upload/image/20150528/1432806526132592.jpg"></p>
<p>数据库服务器配置</p>
<p><img data-src="http://www.178linux.com/ueditor/php/upload/image/20150528/1432806544460922.jpg"></p>
<p>RS1和RS2配置</p>
<p>配置VIP</p>
<p><img data-src="http://www.178linux.com/ueditor/php/upload/image/20150528/1432806562645699.jpg"></p>
<p>配置虚拟主机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@RS1 ~]<span class="comment"># vim /etc/httpd24/extra/httpd-vhosts.conf </span></span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot <span class="string">&quot;/web/discuz&quot;</span></span><br><span class="line">    ProxyRequests Off</span><br><span class="line">    ProxyPassMatch ^/(.*\.php)$ fcgi://172.16.10.110:9000/web/discuz/<span class="variable">$1</span></span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<p>挂载共享目录</p>
<p><img data-src="http://www.178linux.com/ueditor/php/upload/image/20150528/1432806581395256.jpg"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#可设置开机自动挂载</span></span><br><span class="line">[root@scholar ~]<span class="comment"># vim /etc/fstab </span></span><br><span class="line"></span><br><span class="line">172.16.10.110:/web/discuz  /web/discuz             nfs     defaults,_netdev 0 0</span><br></pre></td></tr></table></figure>

<p>检查语法，启动服务</p>
<p><img data-src="http://www.178linux.com/ueditor/php/upload/image/20150528/1432806606253427.jpg"></p>
<p>Director Server配置</p>
<p>配置VIP</p>
<p><img data-src="http://www.178linux.com/ueditor/php/upload/image/20150528/1432806624661613.jpg"></p>
<p>定义集群</p>
<p><img data-src="http://www.178linux.com/ueditor/php/upload/image/20150528/1432806647989976.jpg"></p>
<p>安装测试及访问测试</p>
<p><img data-src="http://www.178linux.com/ueditor/php/upload/image/20150528/1432806668219777.jpg"></p>
<p><img data-src="http://www.178linux.com/ueditor/php/upload/image/20150528/1432806701654411.jpg"></p>
<p><img data-src="http://www.178linux.com/ueditor/php/upload/image/20150528/1432806721619783.jpg"></p>
<p><img data-src="http://www.178linux.com/ueditor/php/upload/image/20150528/1432806867784333.png"></p>
<p>安装完成，我们来发一个帖子测试一下</p>
<p><img data-src="http://www.178linux.com/ueditor/php/upload/image/20150528/1432806895115638.jpg"></p>
<p>过一会儿，刷新一下页面</p>
<p><img data-src="http://www.178linux.com/ueditor/php/upload/image/20150528/1432806917592168.jpg"></p>
<p>此过程中是否实现了负载均衡，我们在Director Server上查看一下是哪台服务器响应的请求就知道了</p>
<p><img data-src="http://www.178linux.com/ueditor/php/upload/image/20150528/1432806954981906.jpg"></p>
<p>由此可见，基于LVS实现web服务器的负载均衡功能已完成</p>
<h2 id="The-end"><a href="#The-end" class="headerlink" title="The end"></a>The end</h2><p>OK，基于LVS的负载均衡就说到这里了，负载均衡集群的配置还是比较简单的，几条命令就搞定了，不要因为简单看一眼就略过，只有理解原理结合实践才能真正掌握知识，配置过程中遇到问题可留言呦。以上仅为个人学习整理，如有错漏，大神勿喷~~~</p>
<p>转载自：<a target="_blank" rel="noopener" href="http://www.178linux.com/archives/4855">http://www.178linux.com/archives/4855</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.yvanz.com/2015/05/09/zabbix-post-a-mail.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://statics.yvanz.com/avatar.jpg">
      <meta itemprop="name" content="Yvan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yvanの平行时空">
      <meta itemprop="description" content="若当初的你，和现在的我，可以重来过">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Yvanの平行时空">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/05/09/zabbix-post-a-mail.html" class="post-title-link" itemprop="url">zabbix邮件告警设置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-05-09 18:05:21" itemprop="dateCreated datePublished" datetime="2015-05-09T18:05:21+08:00">2015-05-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF%E5%AE%85/" itemprop="url" rel="index"><span itemprop="name">技术宅</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2015/05/09/zabbix-post-a-mail.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/05/09/zabbix-post-a-mail.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>好久没更关于zabbix的东西了，今天完善了一下内网zabbix监控的邮件告警功能。</p>
<p>这里就不赘述使用服务器自带邮件发信了，直接介绍使用maix联合自有常用邮箱实现发送邮件的功能。</p>
<ul>
<li>配置发信功能</li>
</ul>
<p>首先使用which mailx检查服务器是否安装mailx，若没有安装直接yum安装。</p>
<p>然后编辑其配置文件，在末尾加上发信邮箱等信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/mail.rc</span><br><span class="line"><span class="comment">#For zabbix media</span></span><br><span class="line"><span class="built_in">set</span> from=你的邮箱 smtp=你的邮箱smtp服务器</span><br><span class="line"><span class="built_in">set</span> smtp-auth-user=你的邮箱 smtp-auth-password=邮箱密码</span><br><span class="line"><span class="built_in">set</span> smtp-auth=login</span><br></pre></td></tr></table></figure>

<p>测试新加的配置信息是否正常</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;zabbix test mail&quot;</span> |mail -s <span class="string">&quot;zabbix&quot;</span> yyy@qq.com</span><br></pre></td></tr></table></figure>

<p>若QQ邮箱成功收信，则配置成功</p>
<ul>
<li>配置zabbix</li>
</ul>
<p>1.新建媒介</p>
<p>点击Administration→Media types→Create media type</p>
<p><img data-src="https://statics.yvanz.com/zabbix-mail1.jpg"></p>
<p>Type选择Script，根据自己习惯，自定义Name字段以及Script name字段。其中Script name字段为待会新建的发信脚本名称。</p>
<p>2.设置报警邮箱</p>
<p>点击Administration→Users，选择Members列的用户，为其配置Media</p>
<p><img data-src="https://statics.yvanz.com/zabbix-mail3.jpg"></p>
<p><img data-src="https://statics.yvanz.com/zabbix-mail2.jpg"></p>
<p>3.设置报警触发行为</p>
<p>点击Configuration→Actions，我们可以直接修改现有的Report problems to Zabbix administrators。选择Opreations页，Edit现有的触发行为，注意修改如下几项并最后update</p>
<p><img data-src="https://statics.yvanz.com/zabbix-mail4.jpg"></p>
<p>4.编辑发信脚本</p>
<p>zabbix默认脚本目录位于zabbix安装目录下的share&#x2F;zabbix&#x2F;alertscripts。我们在这里新建一个前面命名的mail.sh文件，内容如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$3</span>&quot;</span> | mail -s <span class="string">&quot;<span class="variable">$2</span>&quot;</span> <span class="variable">$1</span></span><br></pre></td></tr></table></figure>

<p>若该脚本发信时，邮箱收到的中文显示乱码，且正文为空，同时显示收到一个命名规则为tcmime.***.***.***.bin的附件，可yum安装dos2unix</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">export</span> LANG=zh_CN.UTF-8</span><br><span class="line">FILE=/tmp/mailinfo.txt</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$3</span>&quot;</span> &gt;<span class="variable">$FILE</span></span><br><span class="line">dos2unix -k <span class="variable">$FILE</span></span><br><span class="line">mail -s <span class="string">&quot;<span class="variable">$2</span>&quot;</span> <span class="variable">$1</span> &lt; <span class="variable">$FILE</span></span><br></pre></td></tr></table></figure>

<p>保存并修改脚本所属用户以及赋予执行权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chown</span> zabbix zabbix mail.sh</span><br><span class="line"><span class="built_in">chmod</span> +x mail.sh</span><br></pre></td></tr></table></figure>

<ul>
<li>测试报警</li>
</ul>
<p>关闭监控服务器上的zabbix_agentd，等待若干分钟会收到错误报警的邮件。开启zabbix_agentd，等待若干分钟会收到服务恢复的邮件。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.yvanz.com/2015/04/07/linux-tcp-summary.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://statics.yvanz.com/avatar.jpg">
      <meta itemprop="name" content="Yvan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yvanの平行时空">
      <meta itemprop="description" content="若当初的你，和现在的我，可以重来过">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Yvanの平行时空">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/04/07/linux-tcp-summary.html" class="post-title-link" itemprop="url">Linux TCP队列相关参数的总结</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-04-07 12:01:00" itemprop="dateCreated datePublished" datetime="2015-04-07T12:01:00+08:00">2015-04-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF%E5%AE%85/" itemprop="url" rel="index"><span itemprop="name">技术宅</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2015/04/07/linux-tcp-summary.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/04/07/linux-tcp-summary.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>锋寒 技术保障 基础平台 技术专家</p>
<p>&amp;nbsp;</p>
<p>在Linux上做网络应用的性能优化时，一般都会对TCP相关的内核参数进行调节，特别是和缓冲、队列有关的参数。网上搜到的文章会告诉你需要修改哪些参数，但我们经常是知其然而不知其所以然，每次照抄过来后，可能很快就忘记或混淆了它们的含义。本文尝试总结TCP队列缓冲相关的内核参数，从协议栈的角度梳理它们，希望可以更容易的理解和记忆。注意，本文内容均来源于参考文档，没有去读相关的内核源码做验证，不能保证内容严谨正确。作为Java程序员没读过内核源码是硬伤。</p>
<p>下面我以server端为视角，从&amp;nbsp;<wbr /><span style="word-wrap: normal; word-break: normal; line-height: 24px; box-sizing: border-box; font-weight: 700;">连接建立</span>、&amp;nbsp;<wbr /><span style="word-wrap: normal; word-break: normal; line-height: 24px; box-sizing: border-box; font-weight: 700;">数据包接收</span>&amp;nbsp;<wbr />和&amp;nbsp;<wbr /><span style="word-wrap: normal; word-break: normal; line-height: 24px; box-sizing: border-box; font-weight: 700;">数据包发送</span>&amp;nbsp;<wbr />这3条路径对参数进行归类梳理。</p>
<p>一、连接建立</p>
<p><img data-src="http://img4.tbcdn.cn/L1/461/1/33c6ebe8e3f20cbe799ff483bec551d0d0cdf798"></p>
<p>简单看下连接的建立过程，客户端向server发送<code>SYN</code>包，server回复<code>SYN＋ACK</code>，同时将这个处于<code>SYN_RECV</code>状态的连接保存到半连接队列。客户端返回<code>ACK</code>包完成三次握手，server将<code>ESTABLISHED</code>状态的连接移入accept队列，等待应用调用accept()。</p>
<p>可以看到建立连接涉及两个队列：</p>
<ul>
<li><span style="word-wrap: normal; word-break: normal; line-height: 24px; box-sizing: border-box; font-weight: 700;">半连接队列</span>，保存<code>SYN_RECV</code>状态的连接。队列长度由<code>net.ipv4.tcp_max_syn_backlog</code>设置</li>
<li><span style="word-wrap: normal; word-break: normal; box-sizing: border-box; font-weight: 700;">accept队列</span>，保存<code>ESTABLISHED</code>状态的连接。队列长度为<code>min(net.core.somaxconn, backlog)</code>。其中backlog是我们创建<code>ServerSocket(int port,int backlog)</code>时指定的参数，最终会传递给listen方法：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include </span></span><br><span class="line">int listen(int sockfd, int backlog);</span><br></pre></td></tr></table></figure>

<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">如果我们设置的</span><code>backlog</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">大于</span><code>net.core.somaxconn</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">，accept队列的长度将被设置为</span><code>net.core.somaxconn</code></p>
<p>另外，为了应对<code>SYN flooding</code>（即客户端只发送SYN包发起握手而不回应ACK完成连接建立，填满server端的半连接队列，让它无法处理正常的握手请求），Linux实现了一种称为<code>SYN cookie</code>的机制，通过<code>net.ipv4.tcp_syncookies</code>控制，设置为1表示开启。简单说<code>SYN cookie</code>就是将连接信息编码在<code>ISN</code>(initial sequence number)中返回给客户端，这时server不需要将半连接保存在队列中，而是利用客户端随后发来的ACK带回的<code>ISN</code>还原连接信息，以完成连接的建立，避免了半连接队列被攻击SYN包填满。对于一去不复返的客户端握手，不理它就是了。</p>
<p>二、数据包的接收</p>
<p>先看看接收数据包经过的路径：</p>
<p><img data-src="http://img3.tbcdn.cn/L1/461/1/73d01c4c8164ae8642ff09d5d3fe0548d4162874"></p>
<p>数据包的接收，从下往上经过了三层：网卡驱动、系统内核空间，最后到用户态空间的应用。Linux内核使用<code>sk_buff</code>(<a target="_blank" rel="noopener" href="http://vger.kernel.org/~davem/skb.html">socket kernel buffers</a>)数据结构描述一个数据包。当一个新的数据包到达，<code>NIC</code>（network interface controller）调用<code>DMA engine</code>，通过<code>Ring Buffer</code>将数据包放置到内核内存区。<code>Ring Buffer</code>的大小固定，它不包含实际的数据包，而是包含了指向<code>sk_buff</code>的描述符。当<code>Ring Buffer</code>满的时候，新来的数据包将给丢弃。一旦数据包被成功接收，<code>NIC</code>发起中断，由内核的中断处理程序将数据包传递给IP层。经过IP层的处理，数据包被放入队列等待TCP层处理。每个数据包经过TCP层一系列复杂的步骤，更新TCP状态机，最终到达<code>recv Buffer</code>，等待被应用接收处理。有一点需要注意，数据包到达<code>recv Buffer</code>，TCP就会回<code>ACK</code>确认，既TCP的<code>ACK</code>表示数据包已经被操作系统内核收到，但并不确保应用层一定收到数据（例如这个时候系统crash），因此一般建议应用协议层也要设计自己的确认机制。</p>
<p>上面就是一个相当简化的数据包接收流程，让我们逐层看看队列缓冲有关的参数。</p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; font-weight: bold; line-height: 24px;">1.网卡Bonding模式</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">当主机有1个以上的网卡时，Linux会将多个网卡绑定为一个虚拟的bonded网络接口，对TCP&#x2F;IP而言只存在一个bonded网卡。多网卡绑定一方面能够提高网络吞吐量，另一方面也可以增强网络高可用。Linux支持7种Bonding模式：</span></p>
<ul>
<li><code>Mode 0 (balance-rr)</code>&amp;nbsp;<wbr />Round-robin策略，这个模式具备负载均衡和容错能力</li>
<li><code>Mode 1 (active-backup)</code>&amp;nbsp;<wbr />主备策略，在绑定中只有一个网卡被激活，其他处于备份状态</li>
<li><code>Mode 2 (balance-xor)</code>&amp;nbsp;<wbr />XOR策略，通过源MAC地址与目的MAC地址做异或操作选择slave网卡</li>
<li><code>Mode 3 (broadcast)</code>&amp;nbsp;<wbr />广播，在所有的网卡上传送所有的报文</li>
<li><code>Mode 4 (802.3ad)</code>&amp;nbsp;<wbr />IEEE 802.3ad 动态链路聚合。创建共享相同的速率和双工模式的聚合组</li>
<li><code>Mode 5 (balance-tlb)</code>&amp;nbsp;<wbr />Adaptive transmit load balancing</li>
<li><code>Mode 6 (balance-alb)</code>&amp;nbsp;<wbr />Adaptive load balancing</li>
</ul>
<p>&amp;nbsp;</p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">​</span><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">详细的说明参考内核文档</span><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/networking/bonding.txt">Linux Ethernet Bonding Driver HOWTO</a><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">。我们可以通过</span><code>cat /proc/net/bonding/bond0</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">查看本机的Bonding模式：</span></p>
<p><img data-src="http://img4.tbcdn.cn/L1/461/1/a252ea502f0c109d6db0d6ccbba269e38fea7843"></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">一般很少需要开发去设置网卡Bonding模式，自己实验的话可以参考</span><a target="_blank" rel="noopener" href="http://linux.cloudibee.com/2009/10/linux-network-bonding-setup-guide/">这篇文档</a></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; font-weight: bold; line-height: 24px;">2.网卡多队列及中断绑定</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">随着网络的带宽的不断提升，单核CPU已经不能满足网卡的需求，这时通过多队列网卡驱动的支持，可以将每个队列通过中断绑定到不同的CPU核上，充分利用多核提升数据包的处理能力。</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">首先查看网卡是否支持多队列，使用</span><code>lspci -vvv</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">命令，找到</span><code>Ethernet controller</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">项：</span></p>
<p><img data-src="http://img1.tbcdn.cn/L1/461/1/08914f8ebbbb226e39f2e6e04f574e361e87b0ed"></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">如果有MSI-X， Enable+ 并且Count &gt; 1，则该网卡是多队列网卡。</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">然后查看是否打开了网卡多队列。使用命令</span><code>cat /proc/interrupts</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">，如果看到eth0-TxRx-0表明多队列支持已经打开：</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;"><img data-src="http://img4.tbcdn.cn/L1/461/1/1b58f78cd7e41704b2b1504cb1bb1bb3433c421c"></span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">最后确认每个队列是否绑定到不同的CPU。</span><code>cat /proc/interrupts</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px; ">查询到每个队列的中断号，对应的文件</span><code>/proc/irq/$&#123;IRQ_NUM&#125;/smp_affinity</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px; ">为中断号IRQ_NUM绑定的CPU核的情况。以十六进制表示，每一位代表一个CPU核：</span></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">（00000001）代表CPU0</span><br><span class="line">（00000010）代表CPU1</span><br><span class="line">（00000011）代表CPU0和CPU1</span><br></pre></td></tr></table></figure>

<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">如果绑定的不均衡，可以手工设置，例如：</span></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;1&quot;</span> &gt; /proc/irq/99/smp_affinity  </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;2&quot;</span> &gt; /proc/irq/100/smp_affinity  </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;4&quot;</span> &gt; /proc/irq/101/smp_affinity  </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;8&quot;</span> &gt; /proc/irq/102/smp_affinity  </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;10&quot;</span> &gt; /proc/irq/103/smp_affinity  </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;20&quot;</span> &gt; /proc/irq/104/smp_affinity  </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;40&quot;</span> &gt; /proc/irq/105/smp_affinity  </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;80&quot;</span> &gt; /proc/irq/106/smp_affinity </span><br></pre></td></tr></table></figure>

<p><span style="word-wrap: normal; word-break: normal; line-height: 24px; font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; box-sizing: border-box; font-weight: 700;">3.Ring Buffer</span></p>
<p><code>Ring Buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">位于NIC和IP层之间，是一个典型的FIFO（先进先出）</span><a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Circular_buffer">环形队列</a><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px; ">。</span><code>Ring Buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">没有包含数据本身，而是包含了指向</span><code>sk_buff</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">（</span><a target="_blank" rel="noopener" href="http://vger.kernel.org/~davem/skb.html">socket kernel buffers</a><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">）的描述符。</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">可以使用</span><code>ethtool -g eth0</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">查看当前</span><code>Ring Buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">的设置：</span></p>
<p><img data-src="http://img1.tbcdn.cn/L1/461/1/2e7a9a3a5da675786312e6eefbf0b5959b4be130"></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">上面的例子接收队列为4096，传输队列为256。可以通过</span><code>ifconfig</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">观察接收和传输队列的运行状况：</span></p>
<p><img data-src="http://img1.tbcdn.cn/L1/461/1/ad04bdd5ec90d2fb24e763e6903cdd16d4a48d74"></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27px;">&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 1.RX errors:&amp;nbsp;收包总的错误数</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27px;">&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 2.RX dropped:&amp;nbsp;表示数据包已经进入了</span><code>Ring Buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27px;">，但是由于内存不够等系统原因，导致在拷贝到内存的过程中被丢弃。</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27px;">&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 3.RX overruns:&amp;nbsp;overruns意味着数据包没到</span><code>Ring Buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27px;">就被网卡物理层给丢弃了，而CPU无法及时的处理中断</span><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27px;">是造成</span><code>Ring Buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27px;">满的原因之一，例如中断分配的不均匀。</span><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27px;">当dropped数量持续增加，建议增大</span><code>Ring Buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27px;">，使用</span><code>ethtool -G</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27px;">进行设置。</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; font-weight: bold; line-height: 24px;">4.Input Packet Queue(数据包接收队列)</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">当接收数据包的速率大于内核TCP处理包的速率，数据包将会缓冲在TCP层之前的队列中。接收队列的长度由参数</span><code>net.core.netdev_max_backlog</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">设置。</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; font-weight: bold; line-height: 24px;">5.recv Buffer</span></p>
<p><code>recv buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">是调节TCP性能的关键参数。</span><code>BDP</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">(Bandwidth-delay product，带宽延迟积) 是网络的带宽和与</span><code>RTT</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">(round trip time)的乘积，</span><code>BDP</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">的含义是任意时刻处于在途未确认的最大数据量。</span><code>RTT</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">使用</span><code>ping</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">命令可以很容易的得到。为了达到最大的吞吐量，</span><code>recv Buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">的设置应该大于</span><code>BDP</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">，即</span><code>recv Buffer &gt;= bandwidth * RTT</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px; ">。假设带宽是100Mbps，</span><code>RTT</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">是100ms，那么</span><code>BDP</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">的计算如下：</span></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BDP = 100Mbps * 100ms = (100 / 8) * (100 / 1000) = 1.25MB</span><br></pre></td></tr></table></figure>

<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">Linux在2.6.17以后增加了</span><code>recv Buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px; background-color:">自动调节机制，</span><code>recv buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">的实际大小会自动在最小值和最大值之间浮动，以期找到性能和资源的平衡点，因此大多数情况下不建议将</span><code>recv buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">手工设置成固定值。</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">当</span><code>net.ipv4.tcp_moderate_rcvbuf</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px; background-color:">设置为1时，自动调节机制生效，每个TCP连接的recv Buffer由下面的3元数组指定：</span></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_rmem =   </span><br></pre></td></tr></table></figure>

<p>最初<code>recv buffer</code>被设置为，同时这个缺省值会覆盖<code>net.core.rmem_default</code>的设置。随后<code>recv buffer</code>根据实际情况在最大值和最小值之间动态调节。在缓冲的动态调优机制开启的情况下，我们将<code>net.ipv4.tcp_rmem</code>的最大值设置为<code>BDP</code>。</p>
<p>当<code>net.ipv4.tcp_moderate_rcvbuf</code>被设置为0，或者设置了socket选项<code>SO_RCVBUF</code>，缓冲的动态调节机制被关闭。<code>recv buffer</code>的缺省值由<code>net.core.rmem_default</code>设置，但如果设置了<code>net.ipv4.tcp_rmem</code>，缺省值则被覆盖。可以通过系统调用setsockopt()设置<code>recv buffer</code>的最大值为<code>net.core.rmem_max</code>。在缓冲动态调节机制关闭的情况下，建议把缓冲的缺省值设置为<code>BDP</code>。</p>
<p>注意这里还有一个细节，缓冲除了保存接收的数据本身，还需要一部分空间保存socket数据结构等额外信息。因此上面讨论的<code>recv buffer</code>最佳值仅仅等于<code>BDP</code>是不够的，还需要考虑保存socket等额外信息的开销。Linux根据参数<code>net.ipv4.tcp_adv_win_scale</code>计算额外开销的大小：</p>
<p><img data-src="http://img4.tbcdn.cn/L1/461/1/29e441e2417f14038a2b80fe797124f01960e158"></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">如果</span><code>net.ipv4.tcp_adv_win_scale</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">的值为1，则二分之一的缓冲空间用来做额外开销，如果为2的话，则四分之一缓冲空间用来做额外开销。因此</span><code>recv buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">的最佳值应该设置为：</span></p>
<p><img data-src="http://img4.tbcdn.cn/L1/461/1/1c6cb73c7ca060b6c1dac825f60dcd5e03d5238b"></p>
<p>三、数据包的发送</p>
<p>发送数据包经过的路径：</p>
<p><img data-src="http://img4.tbcdn.cn/L1/461/1/21a3ebef1dadd6d18d982eb3a325dd6075ef14e4"></p>
<p>和接收数据的路径相反，数据包的发送从上往下也经过了三层：用户态空间的应用、系统内核空间、最后到网卡驱动。应用先将数据写入TCP&amp;nbsp;<wbr /><code>send buffer</code>，TCP层将<code>send buffer</code>中的数据构建成数据包转交给IP层。IP层会将待发送的数据包放入队列<code>QDisc</code>(queueing discipline)。数据包成功放入<code>QDisc</code>后，指向数据包的描述符<code>sk_buff</code>被放入<code>Ring Buffer</code>输出队列，随后网卡驱动调用<code>DMA engine</code>将数据发送到网络链路上。</p>
<p>同样我们逐层来梳理队列缓冲有关的参数。</p>
<p><span style="word-wrap: normal; word-break: normal; line-height: 24px; font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; box-sizing: border-box; font-weight: 700;">1.send Buffer</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">同</span><code>recv Buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">类似，和</span><code>send Buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">有关的参数如下：</span></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_wmem =   </span><br><span class="line">net.core.wmem_default</span><br><span class="line">net.core.wmem_max</span><br></pre></td></tr></table></figure>

<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">发送端缓冲的自动调节机制很早就已经实现，并且是无条件开启，没有参数去设置。如果指定了</span><code>tcp_wmem</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">，则</span><code>net.core.wmem_default</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">被</span><code>tcp_wmem</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">的覆盖。</span><code>send Buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">在</span><code>tcp_wmem</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">的最小值和最大值之间自动调节。如果调用</span><code>setsockopt()</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">设置了socket选项</span><code>SO_SNDBUF</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">，将关闭发送端缓冲的自动调节机制，</span><code>tcp_wmem</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">将被忽略，</span><code>SO_SNDBUF</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">的最大值由</span><code>net.core.wmem_max</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">限制。</span></p>
<p><span style="word-wrap: normal; word-break: normal; line-height: 24px; font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; box-sizing: border-box; font-weight: 700;">2.QDisc</span></p>
<p><code>QDisc</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">（queueing discipline ）位于IP层和网卡的</span><code>ring buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">之间。我们已经知道，</span><code>ring buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">是一个简单的FIFO队列，这种设计使网卡的驱动层保持简单和快速。而</span><code>QDisc</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">实现了流量管理的高级功能，包括流量分类，优先级和流量整形（rate-shaping）。可以使用</span><code>tc</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">命令配置</span><code>QDisc</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">。</span></p>
<p><code>QDisc</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">的队列长度由</span><code>txqueuelen</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">设置，和接收数据包的队列长度由内核参数</span><code>net.core.netdev_max_backlog</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">控制所不同，</span><code>txqueuelen</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">是和网卡关联，可以用</span><code>ifconfig</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">命令查看当前的大小：</span></p>
<p><img data-src="http://img1.tbcdn.cn/L1/461/1/6dcf86b5eb148f95d5ea7d64f698734b9b9cd7f3"></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">使用</span><code>ifconfig</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">调整</span><code>txqueuelen</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">的大小：</span></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifconfig eth0 txqueuelen 2000</span><br></pre></td></tr></table></figure>

<p><span style="word-wrap: normal; word-break: normal; line-height: 24px; font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; box-sizing: border-box; font-weight: 700;">3.Ring Buffer</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">和数据包的接收一样，发送数据包也要经过</span><code>Ring Buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">，使用</span><code>ethtool -g eth0</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">查看：</span></p>
<p><img data-src="http://img1.tbcdn.cn/L1/461/1/2e7a9a3a5da675786312e6eefbf0b5959b4be130"></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">其中</span><code>TX</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">项是</span><code>Ring Buffer</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">的传输队列，也就是发送队列的长度。设置也是使用命令</span><code>ethtool -G</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">。</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; font-weight: bold; line-height: 24px;">4.TCP Segmentation和Checksum Offloading</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">操作系统可以把一些TCP&#x2F;IP的功能转交给网卡去完成，特别是Segmentation(分片)和checksum的计算，这样可以节省CPU资源，并且由硬件代替OS执行这些操作会带来性能的提升。</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">一般以太网的</span><code>MTU</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">（Maximum Transmission Unit）为1500 bytes，假设应用要发送数据包的大小为7300bytes，</span><code>MTU</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">1500字节 － IP头部20字节 － TCP头部20字节＝有效负载为1460字节，因此7300字节需要拆分成5个segment：</span></p>
<p><img data-src="http://img1.tbcdn.cn/L1/461/1/f95a88bc6e0327c1173f4736d881ab3e531f9e21"></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">Segmentation(分片)操作可以由操作系统移交给网卡完成，虽然最终线路上仍然是传输5个包，但这样节省了CPU资源并带来性能的提升：</span></p>
<p><img data-src="http://img2.tbcdn.cn/L1/461/1/fae4d502f54dea93565e0facd4fb9686e27d16de"></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">可以使用</span><code>ethtool -k eth0</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">查看网卡当前的offloading情况：</span></p>
<p><img data-src="http://img4.tbcdn.cn/L1/461/1/b682793c235a93fe9a588c7892895659bbdd4111"></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">上面这个例子checksum和tcp segmentation的offloading都是打开的。如果想设置网卡的offloading开关，可以使用</span><code>ethtool -K</code><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">(注意K是大写)命令，例如下面的命令关闭了tcp segmentation offload：</span></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ethtool -K eth0 tso off</span><br></pre></td></tr></table></figure>

<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; font-weight: bold; line-height: 24px;">5.网卡多队列和网卡Bonding模式</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">在数据包的接收过程中已经介绍过了</span><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 24px;">。</span></p>
<p><span style="font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; letter-spacing: 0.479999989271164px; line-height: 27px; ">至此，终于梳理完毕。整理TCP队列相关参数的起因是最近在排查一个网络超时问题，原因还没有找到，产生的&amp;ldquo;副作用&amp;rdquo;就是这篇文档。再想深入解决这个问题可能需要做TCP协议代码的profile，需要继续学习，希望不久的将来就可以再写文档和大家分享了。</span></p>
<p>&amp;nbsp;</p>
<p><span style="word-wrap: normal; word-break: normal; line-height: 24px; font-family: 'Helvetica neue', Helvetica, Arial, 'Hiragino sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; letter-spacing: 0.479999989271164px; box-sizing: border-box; font-weight: 700;">参考文档</span></p>
<p><a target="_blank" rel="noopener" href="http://www.linuxjournal.com/content/queueing-linux-network-stack">Queueing in the Linux Network Stack</a></p>
<p><a target="_blank" rel="noopener" href="http://www.ece.virginia.edu/cheetah/documents/papers/TCPlinux.pdf">TCP Implementation in Linux: A Brief Tutorial</a></p>
<p><a target="_blank" rel="noopener" href="http://sandilands.info/sgordon/impact-of-bandwidth-delay-product-on-tcp-throughput">Impact of Bandwidth Delay Product on TCP Throughput</a></p>
<p><a target="_blank" rel="noopener" href="http://hellojava.info/?p=292">Java程序员也应该知道的系统知识系列之网卡</a></p>
<p><a target="_blank" rel="noopener" href="http://hellojava.info/?p=238">说说网卡中断处理</a></p>
<p>&amp;nbsp;</p>
<p>原文链接：<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_e59371cc0102vg4n.html">http://blog.sina.com.cn/s/blog_e59371cc0102vg4n.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.yvanz.com/2015/04/01/technical-story-behind-the-spring-festival-weibo.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://statics.yvanz.com/avatar.jpg">
      <meta itemprop="name" content="Yvan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yvanの平行时空">
      <meta itemprop="description" content="若当初的你，和现在的我，可以重来过">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Yvanの平行时空">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/04/01/technical-story-behind-the-spring-festival-weibo.html" class="post-title-link" itemprop="url">微博春晚背后的技术故事</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-04-01 23:55:29" itemprop="dateCreated datePublished" datetime="2015-04-01T23:55:29+08:00">2015-04-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF%E5%AE%85/" itemprop="url" rel="index"><span itemprop="name">技术宅</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2015/04/01/technical-story-behind-the-spring-festival-weibo.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/04/01/technical-story-behind-the-spring-festival-weibo.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li>前言</li>
</ul>
<p>一年一度的春晚再次落下帷幕，而微博也顺利地陪伴大家度过除夕之夜。</p>
<p>谈及马年春晚，人们首先想到的不是春晚上精彩的节目，而是微博上的吐槽，边看春晚，边刷微博，边吐槽，已经成了国人的习惯。看春晚不再是为了看节目，而是为了能够在微博上吐槽，知道大家在吐槽什么，更有人戏称不是春晚成就了微博，而是微博拯救了春晚。</p>
<p>马年春晚又格外引人注目，不仅仅是因为冯小刚亲自坐镇，担当总导演，更值得一提的是本届春晚首次将社交平台作为其与观众互动的主要途径，而新浪微博更是成为官方二维码独家合作方。在节目播出时，用户通用手机客户端，扫描屏幕右下角的官方二维码，即可参与春晚的话题讨论。不仅如此，参与讨论的观众，还可以免费获得微博红包，抽大奖的机会。如此一来，大大的提升了微博的活跃度瞬间提升，同时在线人数翻了几倍，给微博系统带来前所未有的访问压力。</p>
<p>根据以往统计的数据，春晚期间微博的访问量将激增到日常水平的数倍之多，而瞬时发表量更是飙升数十倍，如此场景丝毫不亚于淘宝双11和12306抢票时的“盛况”。</p>
<p>而最后的统计数据结果表明，马年春晚直播期间，微博的访问量和发表量都再创新高，而我们系统也自始至终平稳运行，经受住了此次高峰的考验。这成功的背后，是我们的工程师将近一个月的努力。其间面临了哪些问题，又是如何解决的呢？下面，我们一一为大家揭秘。</p>
<ul>
<li>挑战1：如何应对数倍于日常访问量的压力？</li>
</ul>
<p>每年春运抢票时，12306都会崩溃；淘宝双11时，也会有短暂的购买失败的情况。究其原因还是，有限的服务器资源难以承受上千万人同时在线访问。同样，春晚的时候，微博的访问量也会激增，同时在线人数到达日常的数倍之多。面对突然增长的访问压力，大部分互联网公司都会临时扩容来加以应对，同样我们也需要进行扩容。那么如何进行扩容？哪些部分需要扩容？具体扩容多少？这都是厄需解决的问题。</p>
<p>需要提到一点的是，微博目前线上部署了几千台服务器，来保障日常的正常访问。假如面对原来数倍的访问压力时，如果简单粗暴通过线性扩容来应对的话，需要部署原来数倍的服务器，也就是需要上万台服务器。无论从硬件成本还是从管理成本上，这都是不可接受的。那么，又该如何做呢？</p>
<p>在线压测，找极限，最小化扩容前端机</p>
<p>众所周知，为了尽可能的保障线上运行的服务器的稳定，资源都是有一定冗余度的，一般安全值在30%以上。在面临5倍的访问量时，出于成本的考虑，单纯的扩容难以令人接受。这个时候，就要充分利用每台服务器，在不影响业务性能的前提下，使每台服务器的利用率发挥到极限，可以极大的降低资源扩容的数量。如何评估服务器的承受极限是其中的关键，为此我们在业务低峰时期，对线上的服务器进行了实际的压测。具体方法如下：</p>
<p>假如线上一个服务池里有300台 tomcat服务器在提供API服务，正常情况下，每台服务器的负载都小于1（为了简化模型，我们这里只提到了系统load这个指标，实际情况要比这个复杂的多，还要考虑CPU 利用率、带宽、io延迟等）。通过运维系统，我们以10%、20%、30%、40%、50%等比例逐步将该服务池里的300台 tomcat 机器503，通过观察一台 tomcat 服务器的负载以及 API 服务的接口性能，当服务器的负载达到极限或者 API 服务的接口性能达到阈值时，假设此时服务池里正常状态的 tomcat 服务器的数量是100台，那么我们就可以推断出该服务池，极限情况下可以承受3倍与日常的访问压力。同理，为了承担5倍的访问量，只需再扩容一倍机器即可。</p>
<ul>
<li>挑战2：如何应对瞬时可达几万&#x2F;s 的发表量？</li>
</ul>
<p>互联网应用有个显著特点，就是读多写少。针对读多有很多成熟的解决方案，比如可以通过cache 来缓存热数据来降低数据库的压力等方式来解决。而对于写多的情况，由于数据库本身写入性能瓶颈，相对较难解决。</p>
<p>微博系统在处理发表微博时，采用了异步消息队列。具体来讲，就是用户发表微博时，不是直接去更新数据库和缓存，而是先写入到 mcq消息队列中。再通过队列机处理程序读取消息队列中的消息，再写入到数据库和缓存中。那么，如何保证消息队列的读写性能，以及如何保证队列机处理程序的性能，是系统的关键所在。</p>
<p>按消息大小设置双重队列，保证写入速度。</p>
<p>众所知之，微博最大长度不超过140个字，而大部分用户实际发表的微博长度都比较小。为了提高写入消息队列的速度，我们针对不同长度的微博消息，写入不同大小的消息队列。比如以512字节为分界线，大于512字节的写入长队列，小于512字节的写入短队列，其中短队列的单机写入性能要远远高于长队列。实际在线结果表明，短队列的QPS 在万&#x2F;s 级别，长队列的QPS 在千&#x2F;s 级别，而99%的微博消息长度均小于512字节。这种优化，大大提高了微博消息的写入和读取性能。</p>
<p>堵塞队列，压队列机极限处理能力。</p>
<p>为了验证队列机处理程序的极限处理能力，我们在业务低峰时期，对线上队列机进行了实际的压测，具体方法如下：</p>
<p>通过开关控制，使队列机处理程序停止读取消息，从而堵塞消息队列，使堆积的消息分别达到10万，20万，30万，60万，100万，然后再打开开关，使队列机重新开始处理消息，整个过程类似于大坝蓄水，然后开闸泄洪，可想而知，瞬间涌来的消息对队列机将产生极大的压力。通过分析日志，来查找队列机处理程序最慢的地方，也就是瓶颈所在。</p>
<p>通过两次实际的压测模拟，出乎意料的是，我们发现系统在极限压力下，首先达到瓶颈的并非是数据库写入，而是缓存更新。因此，为了提高极限压力下，队列机处理程序的吞吐量，我们对一部分缓存更新进行了优化。</p>
<ul>
<li>挑战3：如何保证系统的可靠性？</li>
</ul>
<p>无论是发微博，还是刷 feed，在微博系统内的处理过程都十分复杂，依赖着各种内部资源和外部服务，保证系统的可靠性显得尤为困难。</p>
<p>为此，我们内部开发了代号为试金石&amp;mdash;&amp;mdash;TouchStone的压测系统，对系统的可靠性进行全面检测。</p>
<p>首先，我们对微博的各个接口进行了服务依赖和资源依赖的梳理，并针对每个服务和资源定义了相应的 SLA 和降级开关。然后，模拟资源或者服务出现异常，再来查看其对接口性能的影响。以 redis资源为例， 假设系统定义了redis的 SLA是300ms，相应的端口是6379，通过 TouchStone，使该端口不可用，从而模拟 redis 资源出现异常，然后验证依赖该资源的接口的性能，确保 SLA 。同时，通过降级开关，对该资源进行降级，验证降级开关的有效。</p>
<p>基于以上方法，对系统进行了全面的检测，并对各个服务和资源的 SLA 和降级开关进行梳理，总结成业务降级手册，保证在出现问题时，运维人员无需开发的介入，也能第一时间根据降级手册进行降级，确保问题能够尽快解决。</p>
<ul>
<li>挑战4：如何保证核心系统的稳定性？</li>
</ul>
<p>任何一个系统，都包含核心系统和非核心系统。在出现异常的情况下，弃车保帅，只保障核心系统的稳定性也是可以接受的。</p>
<p>为此，我们降核心接口和非核心接口拆分，部分部署到不同的应用池子当中，确保非核心业务不会影响核心业务。比如发微博和刷 feed 属于核心业务，而评论，赞属于非核心业务，所以两者应当部署到不同的应用池中。在评论或者赞出现异常时，发微博和刷 feed 就不会受到影响，从而保障系统核心业务的稳定性。</p>
<p>同样，对于一个业务，也要区分核心逻辑和非核心逻辑。以发微博为例，更新缓存和写数据库属于核心逻辑，而给其它业务部门推送数据则属于非核心逻辑。因此，可以将推送数据进行异步化处理，交给单独的线程池处理，在出现异常时，不会对更新缓存和写数据库造成影响。</p>
<ul>
<li>挑战5：如何做到异地容灾？</li>
</ul>
<p>近些年来，异地容灾成为全球性互联网企业面临的难题之一。无论是在国内，以微信为例，还是在国外，以 twitter 为例，都曾经出现过全球性宕机的事故。由此可见，异地容灾仍旧是一个挑战。</p>
<p>微博早在2010年就开始了多机房的部署，如今已经具备三大机房（分别针对联通、电信和海外用户）。</p>
<p>由于人为或者天气等不可抗拒因素，网络故障近年来时有发生。微博的三个机房，各自独立承担了一部分用户的访问。在一个机房出现故障或者压力过大的时候，通过DNS切换等手段，将流量迁移到另外两个机房，从而确保该访问该机房的用户不受影响。一个现实的情况例子，在马年春晚直播期间，由于观看人群的地域分布的特点，出现了联通机房的访问量突增，同时在线人数的增长超过了电信机房和广州机房，我们通过切换一部分联通机房的流量到电信机房，使得联通机房的负载降到了安全值的范围。</p>
<ul>
<li>挑战6：如何实时监控系统状态？</li>
</ul>
<p>我们都知道，地震的发生都是有前兆的，比如一些动物的异常反应。同样，系统中的任何问题出现之前，也是有线索可寻的。这就需要对系统的关键指标做实时的监控，当指标出现异常时，能够第一时间发出报警信息。</p>
<p>为此，我们基于实时流处理系统 Storm 开发了一套监控系统——dashboard。有别于以往的监控系统，它能实时处理系统产生的海量日志，绘制出更加直观的曲线，方便运维进行管理。通过 dashborad，我们能够了解系统的实时状态，主要包括feed的访问量、微博的发表量、队列机的处理性能，消息队列的堆积量等指标。当某个监控指标出现异常时，能够第一时间在 dashboard 中反映出来，从而第一时间采取措施，解决问题，避免问题扩大化。</p>
<ul>
<li>后记</li>
</ul>
<p>春晚已经过去一个月了，渐渐成为回忆。但春晚背后，我们的工程师所付出的巨大的努力所产生的价值，却是一笔宝贵的财富，希望这篇文章能给大家带来启发甚至帮助，也在此向为微博春晚默默贡献的工程师们致敬！</p>
<ul>
<li>关于作者</li>
</ul>
<p>胡忠想（微博昵称：@古月中心相心），目前任职于新浪微博的平台研发部门，主要负责微博 Feed 服务相关工作，曾先后参与微博 Feed 存储、微博计数器、微博阅读数等重大业务产品的开发。2012年3月份毕业于北京航空航天大学计算系，同年4月份，加入新浪微博并工作至今。业余爱好户 外，曾徒步过贡嘎、雨崩，攀登过四姑娘三峰。</p>
<p>感谢张凯峰对本文的审校。</p>
<p>原文链接：<a target="_blank" rel="noopener" href="http://www.infoq.com/cn/articles/technical-story-behind-the-spring-festival-weibo">http://www.infoq.com/cn/articles/technical-story-behind-the-spring-festival-weibo</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.yvanz.com/2015/04/01/weixin-red-envelope.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://statics.yvanz.com/avatar.jpg">
      <meta itemprop="name" content="Yvan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yvanの平行时空">
      <meta itemprop="description" content="若当初的你，和现在的我，可以重来过">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Yvanの平行时空">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/04/01/weixin-red-envelope.html" class="post-title-link" itemprop="url">微信红包系统设计 & 优化</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-04-01 23:51:59" itemprop="dateCreated datePublished" datetime="2015-04-01T23:51:59+08:00">2015-04-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF%E5%AE%85/" itemprop="url" rel="index"><span itemprop="name">技术宅</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2015/04/01/weixin-red-envelope.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/04/01/weixin-red-envelope.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>编者按：经过2014年一年的酝酿，2015微信红包总量创下历史新高，峰值1400万次&#x2F;秒，8.1亿次每分钟，微信红包收发达10.1亿次，系统整体运行平稳, 在这里我分享下微信红包背后的技术。</p>
<ul>
<li>核心功能&amp;目标</li>
</ul>
<p>首先，了解下微信红包的4个逻辑：摇&#x2F;发&#x2F;抢&#x2F;拆。看似简单，实现可不简单再review下微信红包要实现目标：</p>
<p>摇：摇的流畅</p>
<p>快：抢的要快</p>
<p>爽：拆的爽</p>
<p>稳：能分享出去</p>
<ul>
<li>系统难点：</li>
</ul>
<p>1.中国运营商网络环境复杂，覆盖面广，春节期间网络吃紧，容易出现网络故障</p>
<p>2.在尖峰摇时如何避免服务雪崩</p>
<p>3.在服务资源有限时，如何提供柔性服务</p>
<p>4.如何构造有损服务</p>
<p>5.如何构造set模型</p>
<p>6.如何解决并发抢</p>
<p>7.如何实现实现数据一致性</p>
<ul>
<li>系统整体架构图</li>
</ul>
<p><img data-src="http://djt.qq.com/upload/public/common/2015/03/images/150327153526716.png?nothumb=false"></p>
<ul>
<li>跨区域网络解决方案</li>
</ul>
<p>微信客户端分布全球，接入点较多，用户资料靠近接入点，可以加速用户资料访问，但是红包的业务逻辑层并不全网分布，业务逻辑层访问数据层比较多，数据层有状态强一致性问题，只能同用一个数据副本，比如上海用户与深圳用户在同个群里，抢同一个红包，如果订单数据在上海与深圳都有，在抢的时候，无法保证数据同步，可用性低，所以，设计系统时，一定要梳理清楚系统间的调用关系，优化接入层的业务逻辑，把网络耗时降到最小，系统吞吐量才能提升。</p>
<p>跨区域网络问题，在物理实施上，也需要有备份绕行的能力，这个可以在系统的底层框架中实现，当指定专线出现故障时，快速切换网络，恢复服务</p>
<ul>
<li>如何构建有损服务</li>
</ul>
<p>什么是有损服务？选择性牺牲一部分数据一致性和完整性从而保证核心功能绝大多数运行，经过一段时间窗口，数据一致性与完整性能得以恢复，这也是腾讯的一直运营策略，在有限资源前提下，量力而为，满足用户的核心需求</p>
<p>比如，春晚摇一摇，我们的核心点是摇&#x2F;拆&#x2F;分享，那系统的资源优先需要保证这些服务的响应，任何关联系统出现异常的时候马上进行系统降级，防止引起系统雪崩。</p>
<p>系统降级可以分为两个方面，一是把核心功能调用链路简化，减少依赖，通过辅助轻量化的服务实现，确保最短关键路径的可行，比方说在接入层置入摇红包逻辑，将每秒千万级请求转化为每秒万级的红包请求，再传到红包服务的后端逻辑，降低雪崩的可能性。</p>
<ul>
<li>柔性服务.打造好的产品体验</li>
</ul>
<p>柔性可用是在有损服务价值观支持下的方法，重点在于实际上会结合用户使用场景，根据资源消耗，调整产品策略，设计几个级别不同的用户体验场景，保证尽可能成功返回关键数据，并正常接受请求，绝不轻易倒下。</p>
<p>比如，红包的核心功能拆，拆完需要记录用户头像昵称，转帐资金划转，同时输出同个订单下其它拆记录，拆过程这些操作都可能失败，但是核心操作获取红包是成功的，此时，我们至少可以告诉用户抢到金额，不至于让用户焦急等待，不断重试，未完成的操作(头像补全与资金转帐)，可以通异步补尝方式重试。这样解决了用户的问题，也缓解了系统压力。</p>
<ul>
<li>如何构造set模型</li>
</ul>
<p>Set模块就像一个集装箱，把各模块标准化，模块化，规模化，它为海量服务运营，特别是设备管理、网络架构，提供了宏观运营支撑框架，从而极大提高了海量服务运营效率。</p>
<p>微信红包的set模块，以拆服务为例，从接入层开始，数据开始sticky，按订单号路由，即按单号分set，同一个set尽可能在一个IDC 里，减少模块间调用的耗时，在同一个set内，逻辑层任何一台机器，调用方可实时摘除，如果是数据层发生故障，先在接入层，把新产生的红包订单号屏蔽有故障对应的set编号，比如，set1 数据库出现故障，为了避免在故障的set1 上继续产生新的支付请求，在订单生成器直接跳过set1的单号规则，把新请求导致其它set, 只有未抢完的部分红包，会提示故障，稍后恢复，阻止了故障引发的进一步恶化，在故障db上的数据，通过备机与业务逻辑层的数据核对，完成数据一致性的修复。</p>
<ul>
<li>如何解决并发抢</li>
</ul>
<p>群里红包的规则是金额随机抢，在一个大群发一个红包出去，抢并发请求量高，在同一个资源上操作，需要增加锁操作，避免一个抢总数超过发送红包总数，众所周所，mysql的加锁操作，很多抢在一个锁上等，性能损耗大，吞吐量下降，对于海量服务的操作，是不能满足要求。</p>
<p>在set模块的基础上，我们把发&#x2F;抢的资源请求都会落到同一个资源set，在最外层，cache红包的状态，如果红包已经被抢完了，即刻返回，如果红包未接完，对于一个红包进去抢环节还有限流，这是第一级保护，通过一致性hash算法，一一个单到dao层都会路由到同一个机器的同一个进程，dao到mysql在现一个连接上完成抢操作，把并发抢修改成串行化，mysql可以无锁等待，性能明显提升。</p>
<ul>
<li>如何实现数据一致性</li>
</ul>
<p>谈到分布式系统，先回顾CAP理论</p>
<p>C：Consistency数据一致更新，所有变动都是同步的</p>
<p>A：高可用，好的响应性能</p>
<p>P: 分区容忍，可靠性</p>
<p>在我们的系统设计中，同样碰到这个问题，无法同时满足三个因子，移动互联网系统，高可用性是必要要求，数据分区也是分布式系统的条件，所以，我们设计系统时，只能尽量保证数据一致性，只要一定时间窗口内，完成数据一致，让用户满意。</p>
<p>微信红包的数据有几份，订单数据，用户数据，还有对应的cache数据，</p>
<p>N：数据副本份数红包有三份</p>
<p>R: 一次需读取的副本红包一次从一个副本可以全部读取需要数据</p>
<p>W: 一次写入数据2份实时写，一分异步化</p>
<p>R(1) + W(2) &lt;&#x3D;N从公式算出，我们的数据模型也是弱一致性</p>
<p>用户数据是异步更新，更新失败，通过消息中心，异步重试，根据DB资源负载设置调用方的调用阀值，除了实时重试，我们还有准实时数据核对，保证数据最终一致性。</p>
<p>&amp;nbsp;</p>
<p>原文链接：<a target="_blank" rel="noopener" href="http://djt.qq.com/article/view/1349">http://djt.qq.com/article/view/1349</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.yvanz.com/2015/03/11/facebook-mysql-backup.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://statics.yvanz.com/avatar.jpg">
      <meta itemprop="name" content="Yvan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yvanの平行时空">
      <meta itemprop="description" content="若当初的你，和现在的我，可以重来过">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Yvanの平行时空">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/03/11/facebook-mysql-backup.html" class="post-title-link" itemprop="url">Facebook如何实现PB级别数据库自动化备份</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-03-11 23:42:49" itemprop="dateCreated datePublished" datetime="2015-03-11T23:42:49+08:00">2015-03-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF%E5%AE%85/" itemprop="url" rel="index"><span itemprop="name">技术宅</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2015/03/11/facebook-mysql-backup.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/03/11/facebook-mysql-backup.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Facebook的MySQL数据库，是世界上最庞大的MySQL数据库之一，在不同地区有数千个数据库服务器。因此，备份对他们来说是个巨大的挑战。为了解决这个问题，他们构建了一个高度自动化、非常有效的备份系统，每周移动多个PB的数据。Facebook数据团队的Eric Barrett通过一篇文章分享了他们的做法。</p>
<p>他们没有采用大量前载（front-loaded）测试，而是强调快速检测失败，并且进行快速、自动化纠正。部署几百个数据库服务器，只需很少人力干预。使用下面的三个措施，他们做到了有节奏的增长，同时具备支持上十亿用户的灵活性。</p>
<p>措施1：二进制日志和mysqldump</p>
<p>第一道防线称为&amp;ldquo;措施1&amp;rdquo;，或&amp;ldquo;机架&amp;rdquo;备份（rack backup），简称RBU。在每个数据库机架上，不论其类型为何，都有两个RBU存储服务器。以RBU作为数据库服务器放在同一个机架中，这可以保证最大的带宽和最小的延迟，它们同时可以作为缓存，在备份的下个措施使用。</p>
<p>收集二进制日志，是这些服务器的工作之一。二进制日志会不断以流形式，通过模拟从进程（simulated slave process）输送到RBU主机中。这样一来，不需要运行mysqld，RBU就可以接收到同样的更新作为复制版本。</p>
<p>在RBU上保存同步的二进制日志很重要：如果一个主数据库服务器离线，该服务器上的用户将无法更新状态或是上传照片。出现问题后，他们需要保证修复时间越短越好。有可用的二进制日志，就能让他们在数秒内启动另一个数据库作为主数据库。由于RBU中有秒级的二进制日志，即使某个旧主数据库完全不可用，也没有关系，只要利用将记录下的事务恢复到上一个备份中即可完成立即恢复。</p>
<p>RBU服务器的第二个工作是执行传统备份。MySQL备份有两种方式：二进制和逻辑（mysqldump）。Facebook使用逻辑备份，因为它与版本无关，提供更好的数据完整性，更紧凑，恢复起来更省事。不过，当为某个数据库构建全新复制时，他们仍然使用二进制拷贝。</p>
<p>mysqldump的一个主要好处是：磁盘上的数据损坏不会影响到备份中。如果磁盘某个扇区出现问题，或是写入错误，InnoDB页面校验和就会出错。在组合备份流时，MySQL会从内存中读取正确的内容，或是去磁盘读取，然后遇到错误的校验和，停止备份（以及数据库进程）。mysqldump的问题是：污染用来缓存InnoDB块的LRU缓存。不过，新版本的MySQL中，会将LRU插入操作从扫描时放到缓存结束。</p>
<p>对在自己权限范围内的所有数据库，每个RBU都有一个夜间备份。尽管有着天量级别的数据，Facebook的团队还是可以在几个小时内完成对所有数据的备份。</p>
<p>如果RBU失败，自动化软件会将其职责分配给同一集群中其他系统。当它恢复上线后，职责会自动返回到最初的RBU主机。</p>
<p>Facebook团队不会过分担心单个系统的数据保留问题，因为他们有措施2。</p>
<p>措施2：Hadoop DFS</p>
<p>在每个备份和二进制日志收集完成后，他们会马上将其复制到他们的大型定制化Hadoop集群中。这些集群是非常稳定的复制数据集，并有固定的保留时间。因为磁盘大小增长很快，较老的RBU可能不足以保存一到两天的备份。不过他们会按需要增长Hadoop集群，同时不需要担心底层硬件情况。Hadoop的分布式特性让他们有足够带宽，完成快速数据恢复。</p>
<p>不久，他们会把非实时数据分析放到这些Hadoop集群中。这可以降低数据库中非关键读的次数，让Facebook网站的响应速度更快。</p>
<p>措施3：长期存储</p>
<p>每周，他们会从Hadoop备份移动到另一个地区的分散存储中。这些系统是最新而且安全的存储系统，在他们的日常数据管理工具流程之外。</p>
<p>监控</p>
<p>除常用的系统监控外，他们还会捕捉很多特定的统计数据，比如binlog集合延迟、系统容量等等。</p>
<p>为备份失败打分，是他们最有价值的工具。因为Facebook的数据库和同时运行的维护任务量级，错过某些备份也不奇怪。广泛的失败和多日没有成功的单个备份，这都是他们要注意的重点。因此，某个错过备份的得分会随着时间呈指数级增长，这些得分的不同聚合，让团队能对备份的整体健康度有一个有效而快速的了解。</p>
<p>比如，在一天内，某个数据错失一次备份，得1分，一天错失50次备份，就是50分。但在三天内的一次数据库错失，就是27分（3的3次幂），三天内50次，这是很严重的问题，得分就是1350（50乘以3的3次幂）。这会在他们的监控图上出现一个巨大的波峰，团队会马上对其采取行动。</p>
<p>恢复</p>
<p>在系统管理员中有句老话：&amp;ldquo;如果你没有测试过你的备份，就等于没有备份。&amp;rdquo;</p>
<p>因此，Facebook团队构建了一个测试系统，会持续地从措施2开始，将数据恢复到测试服务器上。恢复完成后，他们会执行多次数据完整性检查。如果有任何反复出现的问题，系统就会报警，提醒相关人员关注、审核。该系统可以发现所有问题，包括MySQL的bug，到备份过程中的纰漏，并可以让他们更灵活地应对备份环境中的变化。</p>
<p>他们构建了一个名为ORC（ORC恢复协调器的递归缩写）的系统，工程师如何需要恢复他们所用工具的数据库的过去版本，就可以以自服务方式使用该系统恢复数据。对于快速开发来说还是挺方便的。</p>
<p>在结尾，Eric Barrett说道：</p>
<blockquote>
<p>备份不是最迷人的工程工作。它们即是技术活，又是重复性的，如果一切正常，没人会注意。它们也是跨学科和团队的，需要懂得系统、网络和软件等多方面的专业知识。但是，确保你的记忆和联系安全无误，这是无比重要的事情，而且到最后，也是充满回报的事情。</p>
</blockquote>
<p>有网友问到</p>
<blockquote>
<p>在不运行mysqld的RBU上，你们如何完成二进制日志的流传送？什么是模拟从进程？</p>
</blockquote>
<p>Facebook的MySQL性能工程师Harrison Fisk给出了答案：</p>
<blockquote>
<p>我们使用mysqlbinlog的–never–选项，并有一个用python开发的小包装程序，会监控并保证mysqlbinlog运行成功。</p>
</blockquote>
<p>原文链接：<a target="_blank" rel="noopener" href="http://www.infoq.com/cn/news/2013/02/facebook-mysql-backup">http://www.infoq.com/cn/news/2013/02/facebook-mysql-backup</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.yvanz.com/2015/03/03/ssh-google-authentication.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://statics.yvanz.com/avatar.jpg">
      <meta itemprop="name" content="Yvan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yvanの平行时空">
      <meta itemprop="description" content="若当初的你，和现在的我，可以重来过">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Yvanの平行时空">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/03/03/ssh-google-authentication.html" class="post-title-link" itemprop="url">为Linux开启两步验证</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-03-03 14:21:04" itemprop="dateCreated datePublished" datetime="2015-03-03T14:21:04+08:00">2015-03-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF%E5%AE%85/" itemprop="url" rel="index"><span itemprop="name">技术宅</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2015/03/03/ssh-google-authentication.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/03/03/ssh-google-authentication.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>今天又想折腾了，于是着手试了一遍为服务器开启两步验证增强安全性。话不多说，实战开始。</p>
<ul>
<li>安装依赖包</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install pam-devel gcc-c++ make -y</span><br></pre></td></tr></table></figure>
<p>&amp;nbsp;</p>
<ul>
<li>下载Google-authentication源码，并安装</li>
</ul>
<p>墙内：<a target="_blank" rel="noopener" href="http://pan.baidu.com/s/1eQ1rbNk">百度盘</a></p>
<p>墙外：<a target="_blank" rel="noopener" href="https://google-authenticator.googlecode.com/files/libpam-google-authenticator-1.0-source.tar.bz2">谷歌地址</a></p>
<p>解压</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xjf libpam-google-authenticator-1.0-source.tar.bz2</span><br></pre></td></tr></table></figure>

<p>进入源码目录并安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> libpam-google-authenticator-1.0</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<p>&amp;nbsp;</p>
<ul>
<li>生成验证密钥</li>
</ul>
<p>运行google-authenticator，你可以根据实际情况输入y或者n</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">google-authenticator</span><br><span class="line"></span><br><span class="line">Do you want authentication tokens to be time-based (y/n) y</span><br><span class="line"><span class="comment">#你是否要生成基于时间的认证口令？</span></span><br><span class="line"></span><br><span class="line">https://www.google.com/chart?chs=200x200&amp;chld=M|0&amp;cht=qr&amp;chl=otpauth://totp/root@AY140528171537Z%3Fsecret%3D2YA3XXXXXXXRCEIQ</span><br><span class="line"></span><br><span class="line">Your new secret key is: 2YA3XXXXXXXRCEIQ</span><br><span class="line">Your verification code is 17XXX4</span><br><span class="line">Your emergency scratch codes are:</span><br><span class="line">  51XXXX25</span><br><span class="line">  93XXXX45</span><br><span class="line">  87XXXX39</span><br><span class="line">  98XXXX31</span><br><span class="line">  15XXXX83</span><br><span class="line"><span class="comment">#这五个是紧急状态使用的验证码，谨当无法获取验证码时使用，注意这些紧急验证码用一次就少一个，所以这几个紧急验证码一定要保存好</span></span><br><span class="line"></span><br><span class="line">Do you want me to update your <span class="string">&quot;/root/.google_authenticator&quot;</span> file (y/n) y</span><br><span class="line"><span class="comment">#你希望我更新你的“~/.google_authenticator”文件吗(y/n)？</span></span><br><span class="line"></span><br><span class="line">Do you want to disallow multiple uses of the same authentication</span><br><span class="line">token? This restricts you to one login about every 30s, but it increases</span><br><span class="line">your chances to notice or even prevent man-in-the-middle attacks (y/n) y</span><br><span class="line"><span class="comment">#你希望禁止多次使用同一个验证令牌吗?这限制你每次登录的时间大约是30秒，但是这加大了发现或甚至防止中间人攻击的可能性(y/n)?y</span></span><br><span class="line"></span><br><span class="line">By default, tokens are good <span class="keyword">for</span> 30 seconds and <span class="keyword">in</span> order to compensate <span class="keyword">for</span></span><br><span class="line">possible time-skew between the client and the server, we allow an extra</span><br><span class="line">token before and after the current time. If you experience problems with poor</span><br><span class="line">time synchronization, you can increase the window from its default</span><br><span class="line">size of 1:30min to about 4min. Do you want to <span class="keyword">do</span> so (y/n) y</span><br><span class="line"><span class="comment">#默认情况下，令牌保持30秒有效;为了补偿客户机与服务器之间可能存在的时滞，我们允许在当前时间前后有一个额外令牌。如果你在时间同步方面遇到了问题，可以将窗口从默认大小即1分30秒加大到约4分。你希望这么做吗(y/n)?</span></span><br><span class="line"></span><br><span class="line">If the computer that you are logging into isn<span class="string">&#x27;t hardened against brute-force</span></span><br><span class="line"><span class="string">login attempts, you can enable rate-limiting for the authentication module.</span></span><br><span class="line"><span class="string">By default, this limits attackers to no more than 3 login attempts every 30s.</span></span><br><span class="line"><span class="string">Do you want to enable rate-limiting (y/n) y</span></span><br><span class="line"><span class="string">#如果你登录的那台计算机没有加固，以防范暴力登录，可以对验证模块启用尝试次数限制。默认情况下，这限制攻击者每30秒试图登录的次数只有3次。你希望启用尝试次数限制吗(y/n)?</span></span><br></pre></td></tr></table></figure>
<p>&amp;nbsp;</p>
<ul>
<li>配置ssh使用两步验证模块</li>
</ul>
<p>1.编辑&#x2F;etc&#x2F;pam.d&#x2F;sshd，将下面的内容添加进去</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/pam.d/sshd</span><br><span class="line">auth       required     pam_google_authenticator.so</span><br></pre></td></tr></table></figure>

<p>2.编辑&#x2F;etc&#x2F;ssh&#x2F;sshd_config，将ChallengeResponseAuthentication no改为ChallengeResponseAuthentication yes，并重启sshd服务<br>&amp;nbsp;</p>
<ul>
<li>安装、配置谷歌身份验证器</li>
</ul>
<p>Android：墙内：<a target="_blank" rel="noopener" href="http://shouji.baidu.com/soft/item?docid=3825924">http://shouji.baidu.com/soft/item?docid=3825924</a>&amp;nbsp;墙外：<a target="_blank" rel="noopener" href="https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2">https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2</a></p>
<p>iOS：<a target="_blank" rel="noopener" href="https://itunes.apple.com/gb/app/google-authenticator/id388497605">https://itunes.apple.com/gb/app/google-authenticator/id388497605</a></p>
<p>Windows Phone：<a target="_blank" rel="noopener" href="http://www.windowsphone.com/en-gb/store/app/authenticator/e7994dbc-2336-4950-91ba-ca22d653759b">http://www.windowsphone.com/en-gb/store/app/authenticator/e7994dbc-2336-4950-91ba-ca22d653759b</a></p>
<p>Chrome GAuth Authenticator插件：<a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/gauth-authenticator/jcmgkikfgdbehjdajjdnebnnmmknfblm">https://chrome.google.com/webstore/detail/gauth-authenticator/jcmgkikfgdbehjdajjdnebnnmmknfblm</a></p>
<p>Firefox&amp;nbsp;GAuth Authenticator插件：<a target="_blank" rel="noopener" href="https://marketplace.firefox.com/app/gauth-authenticator/">https://marketplace.firefox.com/app/gauth-authenticator/</a></p>
<p>验证器的配置，这里以Android的APP为例：</p>
<p>打开身份验证器，点击开始设置。在此我们可以“输入提供的密钥”，其中名称可以随意定义，重要的密钥处需要输入上面我们运行google-authenticator时生成的secret key。若当初没有保存，可以查看根目录下的.google_authenticator文件。添加完成之后该软件就会每隔30秒刷新一次验证码。<br>&amp;nbsp;</p>
<ul>
<li>登陆服务器验证</li>
</ul>
<p>打开putty，输入IP和端口，打开该会话。成功登陆会显示如下输入顺序</p>
<p><img data-src="https://statics.yvanz.com/google-authentication-success.png"></p>
<p>即先提示输入身份验证器APP的Verification code验证码，然后再输入Linux的密码。</p>
<p>若显示Using keyboard-interactive authentication却只有Password提示</p>
<p><img data-src="https://statics.yvanz.com/google-authentication-error.png"></p>
<p>说明SELinux为开启状态。因为SELinux会阻止sshd向用户根目录的~&#x2F;.google_authenticator文件进行任何操作，偷懒的解决方式就是关闭SELinux。</p>
<p>&amp;nbsp;</p>
<p>注：SSH登陆时的验证步骤为密钥&#x2F;公钥验证→验证码验证→密码验证，所以在本机有密钥时，会直接登陆服务器，不会触发验证码验证。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">皖ICP备15000396号-1 </a>
  </div>

<div class="copyright">
  &copy; 2012 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yvan</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/yvanz" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/fancybox.js"></script>



  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"yvanz","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
